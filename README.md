# å‰è¨€

è¯·æ±‚å°è£…åœ¨ç½‘ä¸Šå¾ˆå¤šï¼Œå¤§è‡´åˆ†ä¸ºä»¥ä¸‹å‡ ç§å°è£…é£æ ¼ï¼š

- æ™®é€šå°è£…
- ç±»å°è£…
- è£…é¥°å™¨å°è£…
- æ’ä»¶å¼å°è£…
- hookå¼å°è£…

ç½‘ä¸Šæœ€å¤šçš„æ˜¯æ™®é€šå°è£…ï¼ŒåŠŸèƒ½æ¯”è¾ƒé½å…¨ï¼Œå¯ä»¥ä»»æ„ä¿®æ”¹ï¼Œä½†åœ¨æˆ‘çœ‹æ¥è¿™ç§æ–¹å¼åªæ˜¯æŠŠä¸€äº›ä»£ç å†™åˆ°ä¸€èµ·ï¼Œæ¯”è¾ƒæ•£ä¹±ç¼ºå°‘ç»Ÿåˆï¼Œç”¨çš„æ—¶å€™éœ€è¦å¤åˆ¶ç²˜è´´ä»£ç ï¼Œä¸å¤ªç®—çœŸæ­£æ„ä¹‰ä¸Šçš„å°è£…ã€‚

ç±»å°è£…ä¹ŸæŒºå¸¸è§çš„ï¼Œè€Œæˆ‘æ‰€ä½¿ç”¨çš„ä¹Ÿå³æ˜¯ç±»å°è£…ã€‚ç±»å°è£…æœ‰ä¸ªä¼˜ç‚¹ï¼šå¯ä»¥é€šè¿‡ç»§æ‰¿å¤ç”¨æ–¹æ³•ï¼Œä¸”æ›¿æ¢åŸç±»æ–¹æ³•æˆ–åœ¨åŸç±»æ–¹æ³•ä¸Šæ·»åŠ é€»è¾‘ä¹Ÿå¾ˆæ–¹ä¾¿ã€‚

è£…é¥°å™¨å°è£…æ¯”è¾ƒå°‘è§ï¼Œç±»ä¼¼äº`nestjs`é‚£ç§ä½¿ç”¨æ–¹å¼ï¼Œåœ¨ç±»å°è£…çš„åŸºç¡€ä¸ŠåŠ ä¸Šè£…é¥°å™¨ï¼Œä¸è¿‡è¿™ç§æ–¹å¼æœ‰ç‚¹å±€é™æ€§â€”â€”åªèƒ½åœ¨`ts`æˆ–æ„å»ºç¯å¢ƒä¸­ä½¿ç”¨ï¼Œä¸è¿‡å¦‚æœä½ ç¡®å®šä½ çš„é¡¹ç›®ä¸€å®šæ˜¯åœ¨æ„å»ºç¯å¢ƒä¸­å†™çš„è¯é‚£ä¹Ÿå¯ä»¥æ”¾å¿ƒçš„ä½¿ç”¨ã€‚

æ’ä»¶å¼å°è£…ä¹ŸæŒºå°‘è§çš„äº†ï¼Œè¿™ç§æ–¹å¼æ‹“å±•æ€§å¾ˆå¼ºï¼Œæ¨¡å—ç›¸å¯¹ç‹¬ç«‹ï¼Œæˆ‘ä¹Ÿå†™äº†æ’ä»¶å¼å°è£…ï¼Œä¸è¿‡æ€»æ„Ÿè§‰æœ‰ç‚¹ä½¿ç”¨èµ·æ¥ä¸æ˜¯å¾ˆæ–¹ä¾¿ï¼Œä¾¿ä¸äº†äº†ä¹‹äº†ï¼Œæˆ–è®¸ä»¥åå¯ä»¥ä¼˜åŒ–ä¸€ä¸‹ã€‚

hookå¼å°è£…å¤šè§äº`react`æˆ–`vue3`é¡¹ç›®ä¸­ï¼Œä¸æ¡†æ¶å’Œä¸šåŠ¡ç»‘å®šè¾ƒæ·±ï¼Œåœ¨`vue2`æˆ–åŸç”Ÿå¾®ä¿¡å°ç¨‹åºä¸‹å°±ä¸å¥½ä½¿ç”¨äº†ï¼Œä¸è¿‡å®ƒä¸ä¸Šé¢å‡ ä¸ªå°è£…å¹¶ä¸å†²çªï¼Œå¯ä»¥å åŠ ä½¿ç”¨ã€‚


# `request-template`

`request-template`æ˜¯ä¸€æ¬¾å¯å¤ç”¨å¯æ‰©å±•çš„è¯·æ±‚å°è£…åº“ã€‚

- åŸºäº `axios` çš„è¯·æ±‚å°è£…ï¼Œè¯¥åº“ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼å®ç°ï¼Œæ¯ä¸€ä¸ªæ­¥éª¤éƒ½å¯ä»¥è¢«å­ç±»è¦†ç›–æ–¹ä¾¿æ‰©å±•ï¼Œé…ç½®å¯å¤ç”¨ï¼›

- å®ƒä¹Ÿåƒä¸€ä¸ªé€‚é…å™¨ï¼š
  - ä¸ä¸æ¡†æ¶ç»‘å®šï¼šä½ å¯ä»¥ç”¨ vue å†™çš„è¯·æ±‚ï¼Œä¹Ÿèƒ½åœ¨ react ç”šè‡³å°ç¨‹åºä¸Šä½¿ç”¨ï¼›
  - ä¹Ÿä¸ä¸è¯·æ±‚å·¥å…·ç»‘å®šï¼šä½ å¯ä»¥ç”¨`axios`åšä¸ºè¯·æ±‚å·¥å…·ï¼Œä¹Ÿå¯ä»¥ç”¨`fetch`æˆ–`wx.request`ï¼›

- è¿™ä¸æ˜¯ä¸€ä¸ªæœ€ç»ˆæ–¹æ¡ˆï¼Œä¸æ˜¯è¯´ç”¨äº†å®ƒå°±èƒ½ä»€ä¹ˆéƒ½ä¸ç”¨å†™äº†ï¼Œä½†å®ƒèƒ½æå¤§å‡å°‘ä½ çš„ä»£ç å¤æ‚åº¦ï¼Œæé«˜ä»£ç çš„å¤ç”¨æ€§ï¼Œä¸ºä½ çš„æœ€ç»ˆæ–¹æ¡ˆæä¾›æ”¯æŒï¼›ä¹Ÿæ–¹ä¾¿ç§»æ¤ã€‚

å®ƒçš„é…ç½®å¯èƒ½ç›¸å¯¹æ¥è¯´ä¼šç¹çä¸€ç‚¹ï¼Œä½†æ˜¯ä¹‹åä¿®æ”¹å’Œç§»æ¤å°±ä¼šå¾ˆæ–¹ä¾¿äº†ã€‚


GitHubï¼š[https://github.com/mengxinssfd/request-template](https://github.com/mengxinssfd/request-template)

æ¬¢è¿ starã€issueã€pr

# ä¸»è¦å®ç°

- [x] å¤šæ¨¡å—æ”¯æŒ
  - [x] `esm` æ¨¡å—
  - [x] `cjs` æ¨¡å—
- [x] å¤šç¯å¢ƒæ”¯æŒ
  - [x] `æµè§ˆå™¨`
  - [x] `å°ç¨‹åº`
  - [x] `node`
- [x] å¼€æ”¾å¼å°è£…
  - [x] å¯¹äºç»§æ‰¿æ‰©å±•å¼€æ”¾
  - [x] å¯¹äºä½¿ç”¨æ—¶ä¿®æ”¹å…³é—­
- [x] æ¨¡æ¿æ–¹æ³•æ¨¡å¼å®ç°
  - [x] å¯å®ç°è‡ªå®šä¹‰æ¨¡æ¿
  - [x] å¯ç»§æ‰¿å¤ç”¨åŸºç¡€æ¨¡æ¿
- [x] å¤šå®ä¾‹
- [x] ts ç±»å‹æ”¯æŒ
  - [x] èŒƒå‹æ”¯æŒ
  - [x] åŸ axios ç±»å‹æ”¯æŒ
- [x] å¤šçŠ¶æ€å¤„ç†
- [x] æ¥å£ç¼“å­˜
  - [x] è‡ªå®šä¹‰ç¼“å­˜å‘½ä¸­è§„åˆ™
  - [x] è‡ªå®šä¹‰ç¼“å­˜è¿‡æœŸæ—¶é—´
  - [x] æ˜¯å¦ç¼“å­˜å¤±è´¥è¯·æ±‚
- [x] é…ç½®
  - [x] å…¨å±€é…ç½®(ä¿æŒç»Ÿä¸€ï¼Œå¤ç”¨é…ç½®)
  - [x] å±€éƒ¨é…ç½®(æ”¯æŒä¸ªæ€§åŒ–é…ç½®{æŸäº›ä¸æŒ‰è§„èŒƒå®ç°çš„æ¥å£})
- [x] é…ç½®å¤ç”¨
  - [x] ç»§æ‰¿å¤ç”¨
  - [x] å®ä¾‹çº§å¤ç”¨
  - [x] api çº§å¤ç”¨
- [x] å–æ¶ˆè¯·æ±‚
  - [x] å–æ¶ˆå•ä¸ªè¯·æ±‚
  - [x] æ ¹æ® tag å–æ¶ˆè¯·æ±‚
  - [x] å–æ¶ˆæ‰€æœ‰è¯·æ±‚
- [x] è¯·æ±‚å¤±è´¥é‡è¯•
  - [x] é‡è¯•æ¬¡æ•°
  - [x] å»¶æ—¶é‡è¯•
  - [x] ç¬¬ä¸€æ¬¡é‡è¯•ç«‹å³å¯åŠ¨ï¼ˆå¯é€‰ï¼‰
  - [x] å¯ä¸­æ–­é‡è¯•
- [x] æµ‹è¯•è¦†ç›–ç‡100%

# æµç¨‹

```mermaid
flowchart
MergeConfig[fa:fa-spinner åˆå¹¶é…ç½®]
CreateTemplate[fa:fa-spinner åˆ›å»ºæ¨¡æ¿new AxiosRequestTemplate]
GlobalRequestConfig[å…¨å±€è¯·æ±‚é…ç½®]
GlobalCustomConfig[å…¨å±€è‡ªå®šä¹‰é…ç½®]


CreateTemplate --> GlobalRequestConfig --> templateå®ä¾‹
CreateTemplate --> GlobalCustomConfig --> templateå®ä¾‹


templateå®ä¾‹ --> request


request --> MergeConfig --> ä½¿ç”¨ç¼“å­˜?

æ·»åŠ Canceleré’©å­ --> è¿™ä¸€æ­¥åæ‰å¯ä»¥æ‰§è¡Œå–æ¶ˆhandler

ä½¿ç”¨ç¼“å­˜? --> |å¦| è¯·æ±‚å¼€å§‹ --> æ·»åŠ Canceleré’©å­  --> è¯·æ±‚ -->  ç¼“å­˜è¯·æ±‚  --> è¯·æ±‚æˆåŠŸ?

ä½¿ç”¨ç¼“å­˜? --> |æ˜¯| å‘½ä¸­ç¼“å­˜?

å‘½ä¸­ç¼“å­˜?  --> |æ˜¯| ä½¿ç”¨ç¼“å­˜ --> è¯·æ±‚æˆåŠŸ?
å‘½ä¸­ç¼“å­˜?  --> |å¦| è¯·æ±‚å¼€å§‹


è¯·æ±‚æˆåŠŸ? --> |æ˜¯| å¤„ç†è¯·æ±‚ç»“æœ
è¯·æ±‚æˆåŠŸ? --> |å¦| è¯·æ±‚è¢«å–æ¶ˆ? --> |æ˜¯| æ¸…ç†è¯¥è¯·æ±‚ç¼“å­˜ --> ç»“æŸretry --> è¯·æ±‚å®Œæˆ
è¯·æ±‚è¢«å–æ¶ˆ? --> |å¦| retry?

retry? --> |å¦| å¤„ç†è¯·æ±‚ç»“æœ
retry? --> |æ˜¯| æ·»åŠ æ¸…ç†é’©å­ --> è¯·æ±‚å¼€å§‹


å¤„ç†è¯·æ±‚ç»“æœ --> å¤„ç†çŠ¶æ€ --> è¯·æ±‚å®Œæˆ --> æ¸…ç†é’©å­





```

# å®‰è£…

å¯ä»¥ä½¿ç”¨`npm` `cnpm` `yarn` `pnpm`ç­‰æ–¹å¼å®‰è£…

```shell
pnpm add request-template
```

# åŸºç¡€ç”¨æ³•ï¼ˆä½¿ç”¨é»˜è®¤æ¨¡æ¿ï¼‰

## é›¶é…ç½®ç›´æ¥ä½¿ç”¨

è¿™æ—¶çº¦ç­‰äº`axios({url})`

```ts
import axios from 'axios';
import { AxiosRequestTemplate } from 'request-template';

// ä»v1.0.0å¼€å§‹ä¸å†å†…ç½®axiosï¼Œéœ€è¦æŠŠaxiosä¼ è¿›å»
AxiosRequestTemplate.useAxios(axios);
// newä¸€ä¸ªå®ä¾‹
const template = new AxiosRequestTemplate();

// request<T = never, RC extends boolean = false>(requestConfig: Omit<AxiosRequestConfig, 'cancelToken' | 'url'> & {
//        url: string;
//    }, customConfig?: DynamicCustomConfig<CC, RC>): Promise<RC extends true ? AxiosResponse<ResType<T>> : ResType<T>>;

// `request`æ”¯æŒ2ä¸ªå‚æ•°åˆ†åˆ«æ˜¯`axios`çš„è¯·æ±‚è®¾ç½®`requestConfig`ï¼Œä»¥åŠè‡ªå®šä¹‰è®¾ç½®çš„`customConfig`
// `requestConfig`ä¸º`axios`åŸè®¾ç½®ï¼ˆé™¤äº†cancelTokenï¼šæœ‰å¦å¤–ä¸€å¥—æœºåˆ¶å–æ¶ˆï¼‰ï¼Œå…·ä½“å‚æ•°å¯å»axioså®˜æ–¹æŸ¥çœ‹é…ç½®
// `request`é»˜è®¤ä¸º`get`è¯·æ±‚
template.request({ url: '/test', params: { param1: 1, param2: 2 } }).then((res) => {
  console.log(res);
});
// `post`è¯·æ±‚ï¼Œ`delete` `patch`ä¹Ÿæ˜¯ä»¥æ­¤ç±»æ¨
template.request({ url: '/test', data: { param1: 1, param2: 2 }, method: 'post' }).then((res) => {
  console.log(res);
});
```

## ä½¿ç”¨`methodFactory`æ–¹æ³•ç”Ÿæˆä¸€ä¸ª`method`å‡½æ•°

ä¸Šé¢ä½¿ç”¨æ¯æ¬¡éƒ½è¦è®¾ç½®`method`æœ‰äº›éº»çƒ¦äº†ï¼Œå¯ä»¥ç”¨`methodFactory`å‡½æ•°ç”Ÿæˆä¸€ä¸ª`method`å‡½æ•°ç®€åŒ–ä¸€ä¸‹

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
// 'post','get','patch'...
const post = template.methodFactory('post');
post({ url: '/test', data: { param1: 1, param2: 2 } }).then((res) => {
  console.log(res);
});
post({ url: '/test', data: { param1: 1, param2: 2 } }).then((res) => {
  console.log(res);
});
```

æ³¨æ„ï¼š`methodFactory`ç”Ÿæˆçš„ `method`å‡½æ•°ä¸ `request`å‚æ•°è¿”å›å€¼ä¸€è‡´ï¼Œä¸” `requestConfig`é‡Œçš„ `method`å±æ€§ä¸å†èµ·ä½œç”¨

è¯¥æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°æ¥æ”¶ä¸€ä¸ª`handler`å¯ä»¥å¯¹é…ç½®è¿›è¡Œä¸€äº›å¤„ç†ï¼Œå¦‚è®¾ç½®ä¸€äº›å…¬å…± url å‰ç¼€ç­‰ã€‚

## èŒƒå‹æ”¯æŒ

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
const post = template.methodFactory('post');

// æ­¤æ—¶çš„resç±»å‹ä¸º{code:number; data:{username:string;id:number;}; msg:string;}
const res = await post<{ username: string; id: number }>({
  url: '/user',
  data: { param1: 1, param2: 2 },
});
```

è‡ªå®šä¹‰å‚æ•°ä¹Ÿæ”¯æŒèŒƒå‹çº¦æŸä»¥åŠæç¤ºï¼Œåœ¨æ­¤å°±ä¸ä¸€ä¸€å±•ç¤ºäº†

![type-support.png](./docs/type-support.png)

## ä½¿ç”¨ç¼“å­˜

å‘½ä¸­ç¼“å­˜æ—¶ï¼Œè¯¥æ¬¡è¯·æ±‚ç»“æœä¼šç›´æ¥ä»ç¼“å­˜ä¸­æ‹¿ï¼Œä¸ä¼šå‘èµ·æ–°çš„è¯·æ±‚ï¼Œè¢«å–æ¶ˆçš„è¯·æ±‚ä¸ä¼šè¿›å…¥ç¼“å­˜

æ³¨æ„ï¼šç¼“å­˜æ—¶æ‹¿åˆ°è¯·æ±‚ç»“æœæœ€å¥½æ·±æ‹·è´ä¸€ä¸‹ï¼Œå¦åˆ™å¯èƒ½ä¼šå› ä¸ºæ•°æ®è¢«å‰é¢æ“ä½œè€Œå¯¼è‡´å‡ºé—®é¢˜ï¼›ç¼“å­˜å¾ˆå¥½ç”¨ä½†ä¸æ˜¯é“¶å¼¹è¦æ³¨æ„åœºåˆä½¿ç”¨ã€‚

### é»˜è®¤ 5 ç§’å†…ä½¿ç”¨ç¼“å­˜

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
export function getGoodsList(params: {}) {
  // 5ç§’å†…éƒ½ä¼šæ˜¯åŒæ ·çš„æ•°æ®
  return get<{ list: Goods[]; total: number }>({ url: '/goods', params }, { cache: true });
}
```

> å¦‚æœæ˜¯å¤šæ“ä½œçš„åˆ—è¡¨æ•°æ®å‹è¯·æ±‚(ç±»ä¼¼ç”µå•†çš„å•†å“æœç´¢ï¼Œé‡Œé¢æœ‰å¾ˆå¤šç±»ç›®å¯æ“ä½œ)ï¼Œåº”é¿å…ä½¿ç”¨è¿‡é•¿çš„ç¼“å­˜æ—¶é—´ï¼Œå¦åˆ™æœ‰å†…å­˜æº¢å‡ºçš„é£é™©(å¦‚æœç¼“å­˜æ—¶é—´è¿‡é•¿ä¸”ç±»ç›®å¤šã€å¹¶é•¿æ—¶é—´æœªå‘½ä¸­ç¼“å­˜ï¼›å®¹æ˜“å‘½ä¸­çš„ç¼“å­˜ä¸ä¼šæœ‰è¿™ç§é£é™©)ã€‚

### è‡ªå®šä¹‰è¿‡æœŸæ—¶é—´

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
export function getGoodsList(params: {}) {
  // timeoutå•ä½ä¸ºæ¯«ç§’
  return get<{ list: Goods[]; total: number }>(
    { url: '/goods', params },
    { cache: { timeout: 30 * 60 * 1000 } },
  );
}
```

### ç¼“å­˜å¤±è´¥è¯·æ±‚

ä¸€èˆ¬å¾ˆå°‘ä¼šç¼“å­˜å¤±è´¥è¯·æ±‚

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
export function getGoodsList(params: {}) {
  return get<{ list: Goods[]; total: number }>(
    { url: '/goods', params },
    { cache: { timeout: 30 * 60 * 1000, failedReq: true } },
  );
}
```

è¿™æ—¶å€™å¦‚æœè¯·æ±‚å¤±è´¥è¯¥è¯·æ±‚ä¹Ÿä¼šè¢«ç¼“å­˜ï¼Œæ‰€ä»¥ä½ ä¸Šæ¬¡è¯·æ±‚å¤±è´¥æ¥å£è¿”å›ä»€ä¹ˆé”™è¯¯ä¿¡æ¯ï¼Œå¦‚æœä½ ä¸æ”¹æ•°æ®å†æ¬¡å‘½ä¸­ç¼“å­˜è¿˜æ˜¯ä¼šæç¤ºä¸€æ ·çš„é”™è¯¯ä¿¡æ¯ã€‚

### è‡ªå®šä¹‰ç¼“å­˜å‘½ä¸­ç­–ç•¥

> é»˜è®¤ç¼“å­˜å‘½ä¸­ç­–ç•¥ä¸º `{url,headers,data,method,params}` 5 ä¸ªåˆæˆçš„å¯¹è±¡è½¬ä¸ºçš„å­—ç¬¦ä¸²æ˜¯ä¸€æ ·çš„åˆ™ä¼šå‘½ä¸­ç¼“å­˜ã€‚
>
> ç°åœ¨åœ¨åŸæœ‰åŸºç¡€ä¸Šæ·»åŠ ä¸€æ¡ï¼šæ ¹æ®`tag`å‘½ä¸­ç¼“å­˜

éœ€è¦å®ç°è‡ªå®šä¹‰æ¨¡æ¿

```ts
export default class MyCacheTemplate extends AxiosRequestTemplate {
  private readonly cacheKeys = ['cache', 'login'];
  private constructor() {
    super({ baseURL: 'http://test.test' });
  }

  // è½¬æ¢ç¼“å­˜æ‰€ç”¨çš„keyï¼Œé»˜è®¤æ ¹æ®é…ç½®ç”Ÿæˆkey
  protected generateRequestKey(ctx) {
    // åªè¦æ˜¯tagåœ¨cacheKeysä¸­å°±å‘½ä¸­ç¼“å­˜
    const tag = ctx.customConfig.tag;
    if (cacheKeys.includes(tag)) {
      return tag;
    }
    // å¤ç”¨ä¹‹å‰çš„é€»è¾‘
    return super.generateRequestKey(ctx);
  }
}
```

## å–æ¶ˆè¯·æ±‚

å¾ˆå¤šäººä¸çŸ¥é“å–æ¶ˆè¯·æ±‚çš„ä½œç”¨ï¼Œè¯´ä»€ä¹ˆåç«¯è¿˜æ˜¯ä¼šæ”¶åˆ°è¯·æ±‚ï¼Œè¯·æ±‚è¿˜æ˜¯å‘å‡ºå»äº†ä»€ä¹ˆçš„ã€‚

å…¶å®é‚£äº›æˆ‘ä»¬å®Œå…¨ä¸éœ€è¦å…³å¿ƒè¿™äº›ï¼Œ

æˆ‘ä»¬åªéœ€è¦å…³å¿ƒï¼šä¸è¦å†å¤„ç†æ¥å£åç»­ï¼Œä¹Ÿå°±æ˜¯è¯´é‚£äº›æ¥å£ä¸ç®¡æˆä¸æˆåŠŸé‚£äº›ç»“æœæˆ‘éƒ½ä¸è¦äº†ï¼Œè¿™å°±æ˜¯å–æ¶ˆè¯·æ±‚çš„æ„ä¹‰

å½“ç„¶å–æ¶ˆåªå¯¹åº”è·å–æ•°æ®ï¼Œæäº¤æ•°æ®ä¸åº”è¯¥å–æ¶ˆï¼Œå‡ºç°é‡å¤æäº¤åªèƒ½è¯´é€»è¾‘æœ‰é”™ï¼Œè€Œä¸åº”è¯¥é å·¥å…·å…œåº•

### å–æ¶ˆå½“å‰è¯·æ±‚

è·å–`cancleHandler`çš„æ—¶æœºå¾ˆé‡è¦ï¼Œå¿…é¡»åœ¨ `request`ã€`get`ã€`post` ç­‰è¯·æ±‚æ–¹æ³•æ‰§è¡Œåè·å–çš„å–æ¶ˆå‡½æ•°æ‰æ˜¯æœ‰æ•ˆçš„ï¼Œè€Œä¸”å¿…é¡»ä½¿ç”¨å¯¹åº”çš„å®ä¾‹æ¥å–æ¶ˆè¯·æ±‚

```ts
// å¤ç”¨â€˜é»˜è®¤ 5 ç§’å†…ä½¿ç”¨ç¼“å­˜â€™
const req = login({ username: 'test', password: 'test' });
// å¿…é¡»ä½¿ç”¨å¯¹åº”çš„å®ä¾‹æ¥å–æ¶ˆè¯·æ±‚
template.cancelCurrentRequest('cancel message');
try {
  await req;
} catch (e: { message: string }) {
  // ä¼šæ•è·è¯¥æŠ¥é”™
  // message: "cancel message"
}
```

ä½¿ç”¨è¯¥æ–¹æ³•å¯ä»¥å–æ¶ˆå¤±è´¥é‡è¯•`retry`ï¼Œä½†ç”±äºæ—¶æœºéš¾ä»¥ç¡®å®šâ€”â€”å½“å‰è¯·æ±‚å¯èƒ½å˜æˆäº†å…¶ä»–è¯·æ±‚ï¼Œæ‰€ä»¥ä¸æ¨èä½¿ç”¨å®ƒå–æ¶ˆé‡è¯•

### å–æ¶ˆæ‰€æœ‰è¯·æ±‚

```ts
// å¤ç”¨â€˜é»˜è®¤ 5 ç§’å†…ä½¿ç”¨ç¼“å­˜â€™
const req = login({ username: 'test', password: 'test' });
// æˆ–è€…
template.cancelAll('cancel message');
try {
  await req;
} catch (e: { message: string }) {
  // ä¼šæ•è·è¯¥æŠ¥é”™
  // message: "cancel message"
}
```

å¯ä»¥å–æ¶ˆé‡è¯•ï¼Œä½†èŒƒå›´å¤ªå¤§ï¼Œå¯èƒ½ä¼šè¯¯ä¼¤å…¶ä»–è¯·æ±‚ï¼Œéœ€è¦æ…é‡ä½¿ç”¨

### æ ¹æ®`tag`å–æ¶ˆè¯·æ±‚

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
export function login(data: { username: string; password: string }) {
  // timeoutå•ä½ä¸ºæ¯«ç§’
  return post<{ token: string }>('/user/login', data, { tag: 'cancelable' });
}
```

```ts
const req = login({ username: 'test', password: 'test' });
template.cancelWithTag('cancelable', 'cancel message');
try {
  await req;
} catch (e: { message: string }) {
  // ä¼šæ•è·è¯¥æŠ¥é”™
  // message: "cancel message"
}
```

ä½¿ç”¨`tag`æ–¹å¼å–æ¶ˆå¾ˆæ–¹ä¾¿çµæ´»ä¸”å®ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯·æ±‚å‰å–æ¶ˆç›¸åŒ`tag`çš„è¯·æ±‚ï¼›

æˆ–è€…å¤ç”¨æ¨¡æ¿æ—¶æ‰€æœ‰è¯·æ±‚è®¾ç½®ä¸€ä¸ªé»˜è®¤`tag`ï¼Œç„¶åæŸä¸€ä¸ªè¯·æ±‚è®¾ç½®ä¸ºä¸ä¸€æ ·çš„`tag`ï¼Œä»è€Œå®ç°åå‘`tag`å–æ¶ˆçš„åŠŸèƒ½

è¿˜èƒ½å–æ¶ˆæ­£åœ¨æ‰§è¡Œä¸­çš„å¤±è´¥é‡è¯•

## å¤±è´¥é‡è¯•

å¤±è´¥é‡è¯•ç®—æ˜¯æ¯”è¾ƒå°‘ç”¨åˆ°çš„åŠŸèƒ½äº†ï¼Œä½†æ˜¯ç§‰æŒç€`æˆ‘å¯ä»¥ä¸ç”¨ï¼Œä½ ä¸èƒ½æ²¡æœ‰`çš„æƒ³æ³•æŠŠè¿™åŠŸèƒ½ç»™å†…ç½®äº†

### é‡è¯•

é‡è¯• 3 æ¬¡ï¼Œ`http`çŠ¶æ€ç é`200`æ—¶ä¼šé‡è¯• 3 æ¬¡ã€‚å¦‚æœä¸€ç›´å¤±è´¥çš„è¯ï¼ŒåŠ ä¸Šç¬¬ä¸€æ¬¡å¤±è´¥è¯·æ±‚ï¼Œé‚£ä¹ˆæœ€åä¼šå‘èµ· 4 æ¬¡ç›¸åŒè¯·æ±‚

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
try {
  await post({ url: '/retry' }, { retry: 3 });
} catch (e: any) {
  // ä¼šæ•è·æœ€åä¸€æ¬¡è¯·æ±‚çš„é”™è¯¯
}
```

### é‡è¯•é—´éš”

é‡è¯• 3 æ¬¡ï¼Œæ¯æ¬¡é‡è¯•é—´éš” 3 ç§’, `interval`ç¼ºçœæ—¶ä¸º 0 ç§’ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡éƒ½æ˜¯`setTimeout(request, undefined))`è¯·æ±‚

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
try {
  await post({ url: '/retry' }, { retry: { times: 3, interval: 3000 } });
} catch (e: any) {
  // ä¼šæ•è·æœ€åä¸€æ¬¡è¯·æ±‚çš„é”™è¯¯
}
```

### ç¬¬ä¸€æ¬¡é‡è¯•é›¶é—´éš”

é‡è¯• 3 æ¬¡ï¼Œæ¯æ¬¡é‡è¯•é—´éš” 3 ç§’, ç¬¬ä¸€æ¬¡é‡è¯•é›¶é—´éš”ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸€æ¬¡é‡è¯•æ˜¯`setTimeout(request, undefined))`è¯·æ±‚

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
try {
  await post({ url: '/retry' }, { retry: { times: 3, interval: 3000, immediate: true } });
} catch (e: any) {
  // ä¼šæ•è·æœ€åä¸€æ¬¡è¯·æ±‚çš„é”™è¯¯
}
```

### å–æ¶ˆé‡è¯•

é”™è¯¯çš„æ–¹å¼

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
const req = post({ url: '/retry' }, { retry: 3 });
const cancel = template.cancelCurrentRequest;
cancel(); // é”™è¯¯ï¼Œç”±äº`cancelCurrentRequest`ä¼šè®°ä½å½“å‰è¯·æ±‚ï¼Œæ­¤æ—¶æ— æ³•ç¡®å®šå½“å‰æ˜¯å“ªä¸ªè¯·æ±‚
try {
  await req;
  // do something
} catch (e) {
  // do something
}
```

> ç”±äº`cancelCurrentRequest`ä¼šè®°ä½æ­¤æ—¶æ— æ³•ç¡®å®šå½“å‰æ˜¯å“ªä¸ªè¯·æ±‚ï¼Œè™½ç„¶å¯ä»¥ç›´æ¥è°ƒç”¨`template.cancelCurrentRequest()`ï¼Œä½†æ˜¯å¦‚æœè¯·æ±‚å¤šçš„è¯ï¼Œå¯èƒ½ä¼šè¯¯ä¼¤å…¶ä»–è¯·æ±‚ã€‚
>
> æ‰€ä»¥æœ€å¥½çš„åŠæ³•æ˜¯ä½¿ç”¨`tag`æ–¹å¼å–æ¶ˆè¯·æ±‚ã€‚

æ­£ç¡®çš„æ–¹å¼

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
const symbol = Symbol('cancel'); // å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œä½†æ˜¯ç”¨Symbolå¯ä»¥è®©tagä¸ä¼šä¸ä»»ä½•tagé‡å¤
const req = post({ url: '/retry' }, { retry: 3, tag: symbol });
template.cancelWithTag(symbol, 'msg');
try {
  await req;
  // do something
} catch (e) {
  // do something
}
```

## å¤šçŠ¶æ€å¤„ç†

ä½¿ç”¨é»˜è®¤æ¨¡æ¿æ—¶éœ€è¦åå°æ•°æ®ç»“æ„ä¸º`{data:any; code: number; msg: string;}`

è¯·æ±‚çº§çŠ¶æ€å¤„ç†æ›´å¤šæ—¶å€™æ˜¯ä½œä¸ºä¸€ç§è¡¥å……ï¼Œå¸¸ç”¨çŠ¶æ€å¤„ç†æ¨èå†™åˆ°`è‡ªå®šä¹‰æ¨¡æ¿`+`å…¨å±€é…ç½®`ä¸Š

```ts
// ä»£ç å¤ç”¨è‡ª'é›¶é…ç½®ç›´æ¥ä½¿ç”¨'
post(
  '/login',
  {},
  {
    statusHandlers: {
      // codeä¸º200æ—¶è°ƒç”¨
      200(_, res, data) {
        // do something
      },
      // codeä¸º20æ—¶è°ƒç”¨
      20(_, res, data) {
        // do something
      },
    },
  },
);
```

## å…¨å±€é…ç½®

```ts
import { AxiosRequestTemplate } from './AxiosRequestTemplate';

const template = new AxiosRequestTemplate({
  // AxiosRequestConfig axiosé…ç½®
  requestConfig: { data: { a: 1 }, params: { a: 1 } },
  // è‡ªå®šä¹‰é…ç½®
  customConfig: {
    tag: 'cancelable',
    retry: { times: 3, interval: 3000, immediate: true },
    statusHandlers: {
      // codeä¸º200æ—¶è°ƒç”¨
      200(_, res, data) {
        // do something
      },
      // codeä¸º20æ—¶è°ƒç”¨
      20(_, res, data) {
        // do something
      },
    },
    cache: { timeout: 30 * 60 * 1000, enable: true },
  },
});
```

```ts
const post = template.methodFactory('post');
post('/test').then((res) => {
  // do something
});
```

æ­¤æ—¶çš„æ¯æ¬¡è¯·æ±‚éƒ½ä¼šä½¿ç”¨ç¼“å­˜ï¼Œå¸¦ä¸Š`tag`ï¼Œä½¿ç”¨çŠ¶æ€å¤„ç†ï¼Œå¤±è´¥é‡è¯•ï¼Œ `data`æˆ–`params`ä¼šå¸¦ä¸Š`{a:1}`

```ts
post({ url: '/test' }, { cache: true }).then((res) => {
  // do something
});
```

> å…¨å±€`cache`æœ‰ä¸€ä¸ªå°æŠ€å·§ï¼Œå¯ä»¥å…ˆè®¾ç½®`{ timeout: 30 * 60 * 1000, enable: false }`ï¼ŒæŠŠ`enable`è®¾ç½®ä¸º`false`ï¼Œåªè®¾ç½®`timeout`
>
> ç„¶åè¯·æ±‚æ—¶ï¼ŒæŠŠ`cache`è®¾ç½®ä¸º`true`ï¼Œé‚£ä¹ˆå°±å¯ä»¥å…¨å±€ä¸ä½¿ç”¨ç¼“å­˜ï¼Œåªä½¿ç”¨ç¼“å­˜æ—¶é—´ï¼Œè¯·æ±‚æ—¶åªéœ€è¦å¼€å¯è¯·æ±‚ç¼“å­˜åŠŸèƒ½å°±å¥½äº†ï¼Œç®€åŒ–äº†æ“ä½œ

## é…ç½®å¤ç”¨

ç›®å‰æä¾›ä¸‰ä¸ªçº§åˆ«çš„é…ç½®å¤ç”¨ï¼Œåˆ†åˆ«æ˜¯ç»§æ‰¿çº§ã€å®ä¾‹çº§ä»¥åŠ api çº§é…ç½®å¤ç”¨

### ç»§æ‰¿é…ç½®å¤ç”¨

æ‰©å±•æ€§æœ€å¤§çš„æ–¹å¼ï¼Œç»§æ‰¿åä½ å¯ä»¥æ”¹æˆä»»ä½•ä½ éœ€è¦çš„æ ·å­ï¼Œå¯ä»¥å®Œå…¨å¤ç”¨æˆ–é‡æ„æ•´ä¸ªæ¨¡ç‰ˆï¼Œå…·ä½“å¯çœ‹æ¡ˆä¾‹æˆ–å®Œæ•´ demo

### å®ä¾‹é…ç½®å¤ç”¨

åœ¨ new ä¸€ä¸ªå®ä¾‹æ—¶å¸¦ä¸Šå‚æ•°åï¼Œè¯¥å®ä¾‹çš„æ‰€æœ‰è¯·æ±‚éƒ½ä¼šå¸¦ä¸Šå¤ç”¨è¿™äº›å‚æ•°ï¼Œä¾‹å­å¯çœ‹[å…¨å±€é…ç½®](#å…¨å±€é…ç½®)

### api é…ç½®å¤ç”¨

ç›®å‰æä¾› 3 ä¸ªæ–¹æ³•ä»¥ä¾› api é…ç½®å¤ç”¨ï¼Œåˆ†åˆ«æ˜¯`methodFactory`ã€ `use`ã€ `simplifyMethodFactory`æ–¹æ³•

#### `methodFactory`

è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Œæä¾›é…ç½®ç¼“å­˜çš„åŠŸèƒ½ï¼Œæ¥æ”¶`method` `handler`ä¸¤ä¸ªå‚æ•°ï¼Œ`handler`æ”¯æŒç»Ÿä¸€å¯¹é…ç½®ä¿®æ”¹ï¼Œè¿”å›ä¸€ä¸ª`request`æ–¹æ³•

è¯¥æ–¹æ³•è¿”å›çš„`request`æ–¹æ³•`method`ä»¥å›ºå®šï¼Œä¸èƒ½ä¿®æ”¹

ä»¥ç»Ÿä¸€åŠ ä¸Š`url`å‰ç¼€ï¼Œå¹¶ä¸”å…¨éƒ¨æ·»åŠ ç¼“å­˜ä¸ºä¾‹

```ts
import { AxiosRequestConfig } from 'axios';
import { CustomConfig, AxiosRequestTemplate } from 'request-template';

const req = new AxiosRequestTemplate({ requestConfig: { baseURL: 'https://test.com/1' } });

const handler = (config: { requestConfig: AxiosRequestConfig; customConfig: CustomConfig }) => {
  // æ”¯æŒå¯¹axioså’Œè‡ªå®šä¹‰é…ç½®ä¿®æ”¹
  config.requestConfig.url = '/test' + config.requestConfig.url;
  config.customConfig.cache = true;
};
const post = req.methodFactory('post', handler);
const get = req.methodFactory('get', handler);

post({ url: '/path' }); // å®é™…urlä¸º https://test.com/1/test/path
get({ url: '/path' }); // å®é™…urlä¸º https://test.com/1/test/path
```

#### `use`

è¯¥æ–¹æ³•è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Œæä¾›é…ç½®ç¼“å­˜çš„åŠŸèƒ½ï¼Œæ¥æ”¶`config`å‚æ•°ï¼Œ`config` å‚æ•°åŒ…å« `requestConfig` `customConfig` ä¸¤ä¸ªå±æ€§ï¼Œè¿”å›ä¸€ä¸ª`request`æ–¹æ³•

è·Ÿ`methodFactory`çš„åŒºåˆ«æ˜¯`methodFactory`èƒ½é€šè¿‡å›è°ƒä¿®æ”¹é…ç½®ï¼Œè€Œ`use`å†…éƒ¨å®ç°äº†åˆå¹¶é…ç½®ï¼Œä½†æ²¡æœ‰å‡½æ•°çµæ´»ï¼›

è¯¥æ–¹æ³•è¿”å›çš„`request`æ–¹æ³•ä»ç„¶èƒ½æ”¹`method`

ä»¥ç»Ÿä¸€åŠ ä¸Š`url`å‰ç¼€ï¼Œå¹¶ä¸”å…¨éƒ¨æ·»åŠ ç¼“å­˜ä¸ºä¾‹

```ts
import { AxiosRequestConfig } from 'axios';
import { AxiosRequestTemplate } from 'request-template';

const req = new AxiosRequestTemplate({ requestConfig: { baseURL: 'https://test.com/1' } });

// useå†…éƒ¨å®ç°äº†urlä½†æ‹¼æ¥
const post = req.use({
  requestConfig: { method: 'post', url: '/test' },
  customConfig: { cache: true },
});
const get = req.use({
  requestConfig: { method: 'get', url: '/test' },
  customConfig: { cache: true },
});

post({ url: '/path' }); // å®é™…urlä¸º https://test.com/1/test/path
get({ url: '/path' }); // å®é™…urlä¸º https://test.com/1/test/path
```

æ³¨æ„ï¼šè·Ÿå…¶ä»–åº“çš„`use`ä¼šå½±å“åˆ°å®ä¾‹ä¸ä¸€æ ·ï¼Œ`use`åªä¼šå½±å“åˆ°é—­åŒ…å†…çš„è¯·æ±‚

#### `simplifyMethodFactory`

å†™å¤šäº†è¯·æ±‚ä½ ä¼šå‘ç°ï¼šå…¶å®ä½ å¾ˆå°‘ä¼šå»æ”¹`axios`çš„å…¶ä»–é…ç½®ï¼ŒçœŸæ­£å¸¸æ”¹åŠ¨çš„åªæœ‰`method` `url` `data`è¿™ä¸‰ä¸ªå‚æ•°ï¼Œ

ä¹Ÿä¸å…³å¿ƒæ•°æ®æ˜¯å±äº`data`è¿˜æ˜¯`params`ï¼Œæˆ‘åªçŸ¥é“å®ƒæ˜¯æ•°æ®ï¼Œé‡åˆ°`get` `post`ç»™æˆ‘è‡ªåŠ¨è½¬æ¢å°±å¥½ï¼ˆä¸€èˆ¬æ¥è¯´å¾ˆå°‘ä¼šåœ¨`post`è¯·æ±‚é‡Œä¼ `params`ï¼‰

é’ˆå¯¹è¿™ç§æƒ…å†µæˆ‘æä¾›äº†`simplifyMethodFactory`æ–¹æ³•

è¯¥æ–¹æ³•åŒæ ·è¿”å›ä¸€ä¸ªé—­åŒ…ï¼Œæ¥æ”¶`method`å’Œ`urlPrefix`ï¼ˆè€ƒè™‘åˆ°å…¬å…± url å‰ç¼€æŒºå¸¸ç”¨çš„ï¼Œå¯ä¸ä¼ ï¼‰

è¿”å›ä¸€ä¸ªåªæ¥æ”¶`(url:string, data:{}, customConfig:{})`ä¿®æ”¹è¿‡çš„`request`æ–¹æ³•ï¼Œä¸å†æä¾›`axios`é…ç½®ä¿®æ”¹ï¼Œç®€åŒ–æ“ä½œ

```ts
import { AxiosRequestConfig } from 'axios';
import { AxiosRequestTemplate } from 'request-template';

const req = new AxiosRequestTemplate({ requestConfig: { baseURL: 'https://test.com/1' } });

// simplifyMethodFactoryå†…éƒ¨å®ç°äº†urlä½†æ‹¼æ¥
const post = req.simplifyMethodFactory('post', '/test');
const get = req.req.simplifyMethodFactory('get', '/test');

// ä¸ç®¡ä½ æ˜¯dataä¹Ÿå¥½paramsä¹Ÿå¥½ï¼Œæˆ‘éƒ½ä¸å…³å¿ƒï¼Œæˆ‘åªçŸ¥é“å®ƒæ˜¯æ•°æ®ï¼Œæ–¹æ³•å†…éƒ¨ç»™æˆ‘å¤„ç†å¥½å°±è¡Œ

post('/path', { page: 1 }); // å®é™…urlä¸º https://test.com/1/test/path

get('/path', { page: 1 }, { cache: true }); // å®é™…urlä¸º https://test.com/1/test/path
```

# å®é™…åœºæ™¯åŠè§£å†³æ–¹æ¡ˆ

## å…¨å±€è¯·æ±‚`loading`

ä»¥`elementPlus`ä¸ºä¾‹ï¼Œå…·ä½“å¯ä»¥ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„ ui åº“å®ç°ï¼Œè¯¥å®ç°éœ€è¦è‡ªå®šä¹‰æ¨¡æ¿

```ts
import { ElLoading, ILoadingInstance } from 'element-plus';
import { AxiosRequestTemplate, Context, CustomConfig } from 'request-template';

// æ‰©å±•è‡ªå®šä¹‰é…ç½®ï¼Œä»¤apiçš„æ—¶å€™æœ‰tsç±»å‹æç¤º
interface MyConfig extends CustomConfig {
  loading?: boolean;
}

class RequestWithLoading<CC extends MyConfig = MyConfig> extends AxiosRequestTemplate<CC> {
  private loading?: ILoadingInstance;

  // è°ƒèµ·loading
  protected beforeRequest(ctx: Context<CC>) {
    super.beforeRequest(ctx); // å¤ç”¨åŸºç¡€æ¨¡æ¿é€»è¾‘
    if (ctx.customConfig.loading) {
      this.loading = ElLoading.service({ fullscreen: true });
    }
  }
  // å…³é—­loading
  protected afterRequest(ctx) {
    super.afterRequest(ctx); // å¤ç”¨åŸºç¡€æ¨¡æ¿é€»è¾‘
    // åŠ ä¸ªå®šæ—¶å™¨é¿å…è¯·æ±‚å¤ªå¿«ï¼Œloadingä¸€é—ªè€Œè¿‡
    setTimeout(() => {
      this.loading?.close();
    }, 200);
  }
}
```

```ts
// å¯ä»¥é…ç½®é»˜è®¤æ˜¯å¼€å¯è¿˜æ˜¯å…³é—­ï¼Œæ­¤ä¾‹å­é»˜è®¤æ‰€æœ‰çš„éƒ½å¼€å¯
const req = new RequestWithLoading({}, { loading: true });

const get = req.simplifyMethodFactory('get');

// æ­¤æ—¶æ‰€æœ‰çš„è¯·æ±‚éƒ½å¯ä»¥å¸¦ä¸Šloading
get('/test');
get('/test');

// å•ç‹¬æŸä¸ªè¯·æ±‚ä¸ä½¿ç”¨`loading`
get('/test', {}, { loading: false });
```

æ³¨æ„ï¼š`elementPlus`ä¾‹å­å¤šæ¬¡è°ƒç”¨`loading`å¹¶ä¸ä¼šæ‰“å¼€å¤šä¸ª`loading`

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»¥æœåŠ¡çš„æ–¹å¼è°ƒç”¨çš„å…¨å± Loading æ˜¯å•ä¾‹çš„ã€‚ è‹¥åœ¨å‰ä¸€ä¸ªå…¨å± Loading å…³é—­å‰å†æ¬¡è°ƒç”¨å…¨å± Loadingï¼Œå¹¶ä¸ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Loading å®ä¾‹ï¼Œè€Œæ˜¯è¿”å›ç°æœ‰å…¨å± Loading çš„å®ä¾‹

å¦‚æœä½ çš„`loading`ä¸æ˜¯å•ä¾‹çš„ï¼Œé‚£ä¹ˆä½ éœ€è¦è‡ªå·±å¤„ç†ä¸€ä¸‹å¤šä¸ª`loading`å­˜åœ¨å¯èƒ½å¯¼è‡´çš„é—®é¢˜

## å…¨å±€è¯·æ±‚æ˜¾ç¤ºä¿¡æ¯å¼¹çª—

å¾ˆå¤šæ—¶å€™æäº¤æ•°æ®åˆ°æœåŠ¡å™¨éƒ½éœ€è¦æ˜¾ç¤ºæ“ä½œæ˜¯å¦æˆåŠŸçš„ä¿¡æ¯ç»™ç”¨æˆ·ï¼Œæ¯”å¦‚è¯´åˆ›å»ºæ–‡ç« ï¼Œæ›´æ–°æ–‡ç« (å½“ç„¶ä¸æ˜¯æ‰€æœ‰çš„éƒ½æ˜¯ï¼Œæ¯”å¦‚æ˜é‡‘å°±æ˜¯ç›´æ¥è·³é¡µé¢ï¼Œè§†ä¸šåŠ¡è€Œå®š)ï¼Œè¿™æ—¶å€™ç›´æ¥å†™åˆ° api æ–‡ä»¶ä¸Šå°±å¥½äº†

```ts
import { AxiosRequestTemplate, Context, CustomConfig } from 'request-template';
import { Method } from 'axios';
import { statusHandlers } from './statusHandlers';

// æ‰©å±•è‡ªå®šä¹‰é…ç½®
export interface PrimaryCustomConfig extends CustomConfig {
  showSuccessMsg?: boolean;
  successMsg?: string;
}

export class PrimaryRequest<
  CC extends PrimaryCustomConfig = PrimaryCustomConfig,
> extends AxiosRequestTemplate<CC> {
  static readonly ins = new PrimaryRequest();

  private constructor() {
    super({
      requestConfig: { baseURL: import.meta.env.VITE_BASE_URL },
      customConfig: {
        statusHandlers,
        showSuccessMsg: undefined,
      } as CC,
    });
  }

  protected beforeRequest(ctx: Context<CC>) {
    // å¤ç”¨åŸºç¡€æ¨¡æ¿é€»è¾‘
    super.beforeRequest(ctx);

    // æœªè®¾ç½®showSuccessMsgæ—¶ï¼Œä¸”égetè¯·æ±‚åˆ™å…¨éƒ¨æ˜¾ç¤ºè¯·æ±‚æˆåŠŸä¿¡æ¯
    if (ctx.requestConfig.method !== 'get' && ctx.customConfig.showSuccessMsg === undefined) {
      ctx.customConfig.showSuccessMsg = true;
    }
  }
}
export const [Get, Post, Patch, Delete] = PrimaryRequest.ins.methodsWithUrl(
  ['get', 'post', 'patch', 'delete'],
  '',
);
```

åœ¨ç›¸åº”çš„æˆåŠŸ code å›è°ƒä¸Šå†™ä¸Šå¤„ç†

```ts
import { PrimaryCustomConfig } from '@/http/primary/index';
import { HttpStatus, StatusHandler, StatusHandlers } from 'request-template';
import { ElMessage } from 'element-plus';

export const statusHandlers: StatusHandlers<PrimaryCustomConfig> = {
  [HttpStatus.OK]: ({ customConfig }, res, data) => {
    customConfig.showSuccessMsg &&
      ElMessage({ type: 'success', message: customConfig.successMsg || data.msg });
    return customConfig.returnRes ? res : data;
  },
  default: errorHandler,
};
```

api è°ƒç”¨

```ts
// æ›´æ–°æ–‡ç« 
export function updateArticle(articleId: number | string, data: {}) {
  // é»˜è®¤å¼€å¯ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨showSuccessMsg: falseå…³é—­
  return Patch(`/${articleId}`, data, { successMsg: 'æ›´æ–°æˆåŠŸ' });
}
// ç¼–è¾‘æ–‡ç« 
export function createArticle(data: {}) {
  return Post<{ articleId: number }>('', data, { showSuccessMsg: true, successMsg: 'æ·»åŠ æˆåŠŸ' });
}
```

è¿™æ ·ä¿¡æ¯å¼¹çª—å°±ä¸éœ€è¦ä½ å†™åˆ°ä½ çš„ api è°ƒç”¨çš„ç»„ä»¶ä¸Šäº†ï¼Œæˆ‘åªè¦æ•°æ®ï¼Œå…¶ä»–å¼¹çª—ä»€ä¹ˆçš„æˆ‘ä¸€æ¦‚ä¸ç®¡ï¼Œä¸è¿‡æ¯”è¾ƒå¤æ‚çš„åœºæ™¯è¿˜æ˜¯éœ€è¦å…³é—­è¯¥å¼¹çª—è€Œæ‰‹åŠ¨å®ç°çš„

## å…¨å±€è¯·æ±‚å¸¦ä¸Š`token`

`token`æ“ä½œå°è£…ï¼Œé»˜è®¤ä¿å­˜åˆ°`localStorage`,å¯ä»¥æŒ‰ç…§è‡ªå·±å–œæ¬¢ä¿å­˜åˆ°`sectionStorage`æˆ–`cookie`ä¸Š

```ts
export class Token {
  private static KEY = 'token';

  static set key(key: string) {
    Token.KEY = key;
  }
  static get key(): string {
    return Token.KEY;
  }

  static get(): string {
    return localStorage.getItem(Token.KEY) || '';
  }
  static set(token: string) {
    localStorage.setItem(Token.KEY, token);
  }

  static clear() {
    localStorage.removeItem(Token.KEY);
  }
  static exists(): boolean {
    return !!Token.get();
  }
}
```

çŠ¶æ€ç ä¸º`401`æ—¶æ¸…é™¤`token`, çŠ¶æ€ç ä¸º`207`æ—¶ä¿å­˜`token`, å¯æŒ‰å®é™…ä¸šåŠ¡è°ƒæ•´

```ts
import { StatusHandlers } from 'request-template';
export const statusHandlers: StatusHandlers = {
  401: (ctx, res, data) => {
    Token.clear();
    return Promise.reject(data);
  },
  207: ({ customConfig }, res, data) => {
    data.data.token && Token.set(data.data.token);
    return customConfig.returnRes ? res : data;
  },
};
```

å¦‚æœ`token`æ˜¯æ”¾ç½®åœ¨`headers`ï¼Œé‚£ä¹ˆåœ¨è®¾ç½®`axios`é…ç½®æ—¶é¡ºå¸¦é…ç½®å¥½`headers`

```ts
export class PrimaryRequest extends AxiosRequestTemplate {
  protected handleRequestConfig(url, requestConfig) {
    if (!requestConfig.headers) requestConfig.headers = {};
    Token.exists() && (requestConfig.headers.authorization = `Bearer ${Token.get()}`);
    return super.handleRequestConfig(url, requestConfig);
  }
}
```

ä¹Ÿå¯ä»¥æƒ³å¾ˆå¤šäººé‚£æ ·è®¾ç½®åœ¨æ‹¦æˆªå™¨ä¸Šï¼Œä¸è¿‡ä¸ªäººä¸æ˜¯å¾ˆæ¨èï¼Œè¿™æ ·æœ‰ç‚¹ä¸å¤ªå¥½ç†è§£

```ts
export class PrimaryRequest extends AxiosRequestTemplate {
  protected setInterceptors() {
    this.interceptors.request.use((requestConfig) => {
      if (!requestConfig.headers) requestConfig.headers = {};
      Token.exists() && (requestConfig.headers.authorization = `Bearer ${Token.get()}`);
    });
  }
}
```

## é¡µé¢é¢‘ç¹æ“ä½œæ•°æ®ç¼“å­˜

> æ¯”å¦‚åœ¨ä¸€ä¸ªåˆ—è¡¨é¡µé¢ï¼Œå¯ä»¥é€‰æ‹©åˆ†ç±»ä»¥åŠæ ‡ç­¾ï¼Œè¿˜æœ‰æ’åºæ–¹å¼ï¼ˆå…¶å®å°±æ˜¯æˆ‘çš„åšå®¢ ğŸ˜„ï¼‰ã€‚
> è¿™äº›å¯æ“ä½œåŒºåŸŸå¯èƒ½ä¼šç»å¸¸ç‚¹æ¥ç‚¹å»ï¼Œä½†æ˜¯å…¶å®æ•°æ®ä¸ä¼šåˆ·æ–°é‚£ä¹ˆå¿«ï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿå†—ä½™çš„è¯·æ±‚ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠè¯·æ±‚ç¼“å­˜èµ·æ¥ï¼Œå¹¶é˜»æ­¢æ–°è¯·æ±‚å‘å‡ºã€‚

```ts
const req = new AxiosRequestTemplate();

// api
export function getArticleList(params: { cate: number; tags: number[]; sort: number; p: number }) {
  req.cancelWithTag(tag);
  return req.request({ url: '/api/article', params }, { cache: true });
}
```

ç„¶ååªè¦`{url,headers,data,method,params}`è¿™äº›é…ç½®æ˜¯ä¸€æ ·çš„è¯å°±ä¸ä¼šå‘èµ·æ–°è¯·æ±‚äº†ï¼Œè€Œæ˜¯ç›´æ¥ä»ç¼“å­˜ä¸­æ‹¿æ•°æ®ï¼Œä¸è¿‡æŒ‰`f5`åˆ·æ–°çš„è¯è¿˜æ˜¯ä¼šå‘èµ·è¯·æ±‚çš„ã€‚

å¦‚æœè¦å®ç°æŒ‰`f5`ä¹Ÿè¿˜æ˜¯ä»ç¼“å­˜ä¸­å–æ•°æ®ï¼Œå®ç°è¯·æ±‚ç¼“å­˜åˆ°æœ¬åœ°å­˜å‚¨çš„åŠŸèƒ½ä¹Ÿå¾ˆç®€å•ï¼šåªè¦ç»§æ‰¿`AxiosRequestTemplate` `Cache`ï¼Œå¹¶é‡å†™`Cache`çš„`getter` `setter`ä»¥åŠ`AxiosRequestTemplate`çš„`init`æ–¹æ³•å°±å¯ä»¥å®ç°ã€‚

## post è¯·æ±‚å‚æ•°åºåˆ—åŒ–

> æœ‰æ—¶å€™åç«¯è¦æ±‚`Content-Type`å¿…é¡»ä»¥`application/x-www-form-urlencoded`å½¢å¼ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦å¤„ç†ä¸€ä¸‹`headers`å’Œ`data`

è‡ªå®šä¹‰æ¨¡æ¿

```ts
import Qs from 'qs';
export default class MyTemplate extends AxiosRequestTemplate {
  protected handleRequestConfig(requestConfig) {
    requestConfig = super.handleRequestConfig(requestConfig);
    //  è®¾ç½®headers
    if (!requestConfig.headers) requestConfig.headers = {};
    requestConfig.headers['Content-Type'] = 'application/x-www-form-urlencoded';

    // ä½¿ç”¨qsåºåˆ—åŒ–å‚æ•°
    if (
      String(requestConfig.method).toLowerCase() === 'post' &&
      !(requestConfig.data instanceof FormData)
    ) {
      requestConfig.data = Qs.stringify(requestConfig.data);
    }

    return requestConfig;
  }
}
```

æˆ–è€…ä½¿ç”¨`axios`å…¨å±€é…ç½®

```ts
import Qs from 'qs';
export default class MyTemplate extends AxiosRequestTemplate {
  constructor() {
    //  è®¾ç½®headers
    super({ headers: { 'Content-Type': 'application/x-www-form-urlencoded' } });
  }

  protected handleRequestConfig(requestConfig) {
    requestConfig = super.handleRequestConfig(requestConfig);
    // qsåºåˆ—åŒ–
    if (
      String(requestConfig.method).toLowerCase() === 'post' &&
      !(requestConfig.data instanceof FormData)
    ) {
      requestConfig.data = Qs.stringify(requestConfig.data);
    }
    return requestConfig;
  }
}
```

ä¹Ÿå¯ä»¥ç”¨`requestMethod`æˆ–`use`æ¥å¤ç”¨è¿™äº›é…ç½®ï¼Œå…·ä½“è¦ä½¿ç”¨å“ªä¸ªéœ€è¦è§†å¤ç”¨å¹¿åº¦è€Œå®šã€‚

## åˆ†é¡µåœºæ™¯å¿«é€Ÿåˆ‡æ¢é¡µç æ—¶ä¸­æ–­è¯·æ±‚

> åˆ†é¡µåœºæ™¯ï¼Œå¿«é€Ÿçš„ç‚¹å‡» 1ï¼Œ2ï¼Œ3 é¡µï¼Œå‘å‡ºå» 3 ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚è¿”å›æœ‰å¿«æœ‰æ…¢ï¼Œæœ€åç‚¹å‡»çš„ç¬¬ä¸‰é¡µï¼Œä½†æ˜¯æœ€åè¿”å›çš„æ˜¯ç¬¬äºŒé¡µçš„æ•°æ®ï¼Œé‚£é¡µé¢ï¼Œè‚¯å®šæ˜¯ä¼šæ¸²æŸ“ç¬¬äºŒé¡µçš„ï¼Œæ˜¯ä¸æ˜¯ä¸ª bugï¼Œé‚£ä¹ˆåŒæ—¶è¯·æ±‚äº†å¤šä¸ªç›¸åŒè¯·æ±‚ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥ä¸­æ–­ä¹‹å‰çš„è¯·æ±‚ï¼Œåªæ‰§è¡Œæœ€åä¸€ä¸ªè¯·æ±‚å‘¢

è¿™ç§åœºæ™¯æŒºå¸¸è§çš„ï¼Œè·Ÿä¸Šé¢çš„é¡µé¢é¢‘ç¹æ“ä½œç±»ä¼¼ï¼Œä¸è¿‡ä»ç¼“å­˜æ‹¿æ•°æ®å¾ˆå¿«ï¼Œç”¨æˆ·ç‚¹å‡»ä¸å¯èƒ½ä¼šæ¯”ä»ç¼“å­˜æ‹¿æ•°æ®å¿«ã€‚

è¿™æ˜¯å±äºå‰é¢è¯·æ±‚æ•°æ®ä½œåºŸåœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆç®€å•çš„å®ç°è¯¥åŠŸèƒ½

```ts
const req = new AxiosRequestTemplate();
// ä½¿ç”¨Symbolé¿å…ä¸å…¶ä»–è¯·æ±‚é‡å
const tag = Symbol('xx_list');
// api
export function getXXList(p: number) {
  req.cancelWithTag(tag);
  return req.request({ url: '/xx_list', params: { p } }, { tag });
}
```

åªè¦ç»™è¯¥è¯·æ±‚åŠ ä¸Š`tag`ï¼Œç„¶åæ¯æ¬¡è°ƒç”¨å‰å–æ¶ˆå°±å¥½äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ã€‚

## å‰ç«¯å¹¶å‘ 10 ä¸ªç›¸åŒçš„è¯·æ±‚ï¼Œæ€ä¹ˆæ§åˆ¶ä¸ºåªå‘ä¸€ä¸ªè¯·æ±‚ï¼Ÿ

è¿™é—®é¢˜æ¥æºäº[å‰ç«¯å¹¶å‘ 10 ä¸ªç›¸åŒçš„è¯·æ±‚ï¼Œæ€ä¹ˆæ§åˆ¶ä¸ºåªå‘ä¸€ä¸ªè¯·æ±‚ï¼Ÿ - æ˜é‡‘ (juejin.cn)](https://juejin.cn/post/7052700635154219015)

> ### æè¿°å¦‚ä¸‹
>
> - åŒæ—¶å‘å¤šä¸ªç›¸åŒçš„è¯·æ±‚ï¼Œå¦‚æœç¬¬ä¸€ä¸ªè¯·æ±‚æˆåŠŸï¼Œé‚£ä¹ˆå‰©ä½™çš„è¯·æ±‚éƒ½ä¸ä¼šå‘å‡ºï¼ŒæˆåŠŸçš„ç»“æœä½œä¸ºå‰©ä½™è¯·æ±‚è¿”å›
> - å¦‚æœç¬¬ä¸€ä¸ªè¯·æ±‚å¤±è´¥äº†ï¼Œé‚£ä¹ˆæ¥ç€å‘ç¼–å·ä¸º 2 çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚æˆåŠŸï¼Œé‚£ä¹ˆå‰©ä½™çš„è¯·æ±‚éƒ½ä¸ä¼šå‘å‡ºï¼ŒæˆåŠŸçš„ç»“æœä½œä¸ºå‰©ä½™è¯·æ±‚è¿”å›
> - å¦‚æœç¬¬äºŒä¸ªè¯·æ±‚å¤±è´¥äº†ï¼Œé‚£ä¹ˆæ¥ç€å‘ç¼–å·ä¸º 3 çš„è¯·æ±‚ï¼Œå¦‚æœè¯·æ±‚æˆåŠŸï¼Œé‚£ä¹ˆå‰©ä½™çš„è¯·æ±‚éƒ½ä¸ä¼šå‘å‡ºï¼ŒæˆåŠŸçš„ç»“æœä½œä¸ºå‰©ä½™è¯·æ±‚è¿”å›
> - `...`ä»¥æ­¤é€’æ¨ï¼Œç›´åˆ°é‡åˆ°æœ€åçš„æƒ…å†µéœ€è¦å‘é€æœ€åä¸€ä¸ªè¯·æ±‚
>
> > å¹¶å‘ï¼š ä¸€ä¸ªæ¥å£è¯·æ±‚è¿˜å¤„äº pendingï¼ŒçŸ­æ—¶é—´å†…å°±å‘é€ç›¸åŒçš„è¯·æ±‚

è¿™ä¸ªé—®é¢˜åˆšå¼€å§‹æ—¶çœ‹å²”äº†ï¼Œè¢« 10 ä¸ªè¯·æ±‚è¯¯å¯¼äº†ï¼Œä»¥ä¸º 10 æ¬¡ä»¥åå°±ç”¨å¤±è´¥çš„ã€‚

ä»”ç»†çœ‹åå…¶å®è¯´èµ·æ¥è¿˜æ˜¯ç¼“å­˜é—®é¢˜ï¼Œå°±æ˜¯å¤±è´¥çš„ä¸ç¼“å­˜ï¼Œæœ‰è¯·æ±‚æˆåŠŸçš„å°±è¯·æ±‚ç”¨æˆåŠŸçš„æ•°æ®ï¼Œå¹¶ä¸”è¯·æ±‚æˆåŠŸååç»­åŒç±»è¯·æ±‚ä¸å†å‘å‡ºã€‚

è·Ÿæˆ‘ä¸Šé¢çš„ç¼“å­˜åœºæ™¯ç±»ä¼¼ï¼Œç›´æ¥ç”¨ç¼“å­˜åŠŸèƒ½å°±æ˜¯

```ts
const req = new AxiosRequestTemplate();

export function request() {
  // ä¸çŸ¥é“å®ƒè¦æ±‚å¤šé•¿æ—¶é—´å†…ï¼Œå°±å®šä¸ºæ— é™å§ï¼Œå¹¶ä¸”ä¸ç¼“å­˜å¤±è´¥è¯·æ±‚
  return req.request({ url: '/test' }, { cache: { timeout: Infinity, failedReq: false } });
}
```

# å®Œæ•´ demo

è¿™æ˜¯æˆ‘åšå®¢å‰å°çš„`api`ä½¿ç”¨å°è£…

ç¯å¢ƒï¼švue3ã€viteã€tsã€elementplus

ç›®å½•ç»“æ„

```text
src
â”œâ”€â”€ api
|  â”œâ”€â”€ user.ts // å…·ä½“çš„api
|  â”œâ”€â”€ tag.ts // å…·ä½“çš„api
|  â””â”€â”€ ....
â”œâ”€â”€ http
|  â”œâ”€â”€â”€ primary // ä¸»è¯·æ±‚æ¨¡æ¿
|  |   â”œâ”€â”€ index.ts // è¯·æ±‚æ¨¡æ¿
|  |   â”œâ”€â”€ token.ts // tokenæ“ä½œå·¥å…·ç±»
|  |   â””â”€â”€ statusHandlers.ts // çŠ¶æ€å¤„ç†
|  â””â”€â”€â”€ other  // å…¶ä»–è§„åˆ™æ¨¡æ¿
|      â”œâ”€â”€ index.ts // è¯·æ±‚æ¨¡æ¿
|      â””â”€â”€ statusHandlers.ts // çŠ¶æ€å¤„ç†
```

## ä¸»æ¨¡æ¿å°è£…

### src/primary/token.ts

`token`å°è£…ç±»

```ts
export class Token {
  private static KEY = 'token';

  static set key(key: string) {
    Token.KEY = key;
  }
  static get key(): string {
    return Token.KEY;
  }

  static get(): string {
    return localStorage.getItem(Token.KEY) || '';
  }
  static set(token: string) {
    localStorage.setItem(Token.KEY, token);
  }

  static clear() {
    localStorage.removeItem(Token.KEY);
  }
  static exists(): boolean {
    return !!Token.get();
  }
}
```

### src/primary/statusHandlers.ts

ç»™ç”¨æˆ·æç¤ºé”™è¯¯ä¿¡æ¯ï¼Œ`token`çš„ä¿å­˜ã€æ¸…ç†ã€åˆ·æ–°ç­‰æ“ä½œçš„é€šç”¨å¤„ç†

```ts
import { HttpStatus, StatusHandler, StatusHandlers, CustomConfig, Context } from 'request-template';
import { ElMessage } from 'element-plus';
import { Token } from './token';
import Store from '@/store/index';

// é€šç”¨é”™è¯¯Handler
const commonErrorHandler: StatusHandler<CustomConfig> = ({ customConfig }, res, data) => {
  // éé™éŸ³æ¨¡å¼ä¸‹ï¼Œæœ‰é”™è¯¯ç›´æ¥æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
  !customConfig.silent && ElMessage({ type: 'error', message: data.msg });
  return Promise.reject(customConfig.returnRes ? res : data);
};

export const statusHandlers: StatusHandlers = {
  //  401 tokenå¤±æ•ˆæˆ–è€…æœªç™»å½•
  [HttpStatus.UNAUTHORIZED]: (ctx, res, data) => {
    // ä»vuexæˆ–piniaä¸­åˆ é™¤ç”¨æˆ·ä¿¡æ¯
    // Store.commit('clearUser');
    Token.clear();
    return commonErrorHandler(ctx, res, data);
  },
  // tokenåˆ·æ–°æ—¶
  207: ({ customConfig }, res, data) => {
    data.data.token && Token.set(data.data.token);
    return customConfig.returnRes ? res : data;
  },
  // 200 æ™®é€šæˆåŠŸè¯·æ±‚
  [HttpStatus.OK]: ({ customConfig }, res, data) => {
    return customConfig.returnRes ? res : data;
  },
  // ...
  // å…¶ä½™çŠ¶æ€å…¨éƒ¨èµ°é”™è¯¯å¤„ç†
  default: commonErrorHandler,
};
```

### src/primary/index.ts

å®ç°è‡ªå®šä¹‰è¯·æ±‚æ¨¡æ¿ï¼Œæ·»åŠ å…¨å±€`loading`ã€`token`ã€`uuid`ç­‰, å¹¶ç”Ÿæˆ`Get`ã€`Post`ã€`Patch`ã€`Delete`ç­‰å¸¸ç”¨`method`

```ts
import { Token } from './token';
import { statusHandlers } from './statusHandlers';
import { AxiosRequestTemplate, Context, CustomConfig } from 'request-template';
import { ElLoading, ILoadingInstance } from 'element-plus';
import { Method } from 'axios';

let uuid = localStorage.getItem('uuid');

// æ‰©å±•è‡ªå®šä¹‰é…ç½®ï¼Œä»¤apiä½¿ç”¨çš„æ—¶å€™æœ‰tsç±»å‹æç¤º
interface LoadingCustomConfig extends CustomConfig {
  loading?: boolean;
}

export class PrimaryRequest<
  CC extends LoadingCustomConfig = LoadingCustomConfig,
> extends AxiosRequestTemplate<CC> {
  // å•ä¾‹æ¨¡å¼
  static readonly ins = new PrimaryRequest();

  private loading?: ILoadingInstance;

  private constructor() {
    super(
      // baseUrlï¼Œaxiosé…ç½®ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½ä¼šæ‹¼æ¥ä¸ŠbaseUrlä½œä¸ºå‰ç¼€ï¼Œè·Ÿprocess.env.BASE_URLç±»ä¼¼
      // VITE_BASE_URLå®šä¹‰åœ¨.envæ–‡ä»¶ä¸­ï¼Œæ–¹ä¾¿ä½¿ç”¨ç¯å¢ƒå˜é‡åˆ‡æ¢baseurl
      { baseURL: import.meta.env.VITE_BASE_URL },
      // ç¼“å­˜è®¾ç½®60ç§’
      { statusHandlers, cache: { enable: false, timeout: 60 * 1000 }, loading: false } as CC,
    );
  }

  // è½¬æ¢å“åº”æ•°æ®ç»“æ„ä¸º{code:number; data:any; msg:string}
  // ä¾‹å¦‚æœ‰äº›æ¥å£çš„codeå¯èƒ½å«statusæˆ–ercodeï¼Œmsgå«messageä¹‹ç±»çš„
  // å¦‚æœæ˜¯ä¸€æ ·çš„ç»“æ„å¯ä»¥è·³è¿‡è¯¥æ–¹æ³•
  protected handleResponse(ctx: Context<CC>, response: AxiosResponse) {
    const data = (response?.data as ResType) || {};
    return {
      code: data.code,
      data: data.data,
      msg: data.msg,
    };
  }

  // è¯·æ±‚å‰å¼€å¯loading
  protected beforeRequest(ctx: Context<CC>) {
    super.beforeRequest(ctx); // å¤ç”¨åŸºç¡€æ¨¡æ¿é€»è¾‘
    if (ctx.customConfig.loading) {
      this.loading = ElLoading.service({ fullscreen: true });
    }
  }

  // è¯·æ±‚åå…³é—­loading
  protected afterRequest(ctx) {
    super.afterRequest(ctx); // å¤ç”¨åŸºç¡€æ¨¡æ¿é€»è¾‘
    // åŠ ä¸ªå®šæ—¶å™¨é¿å…è¯·æ±‚å¤ªå¿«ï¼Œloadingä¸€é—ªè€Œè¿‡
    setTimeout(() => {
      this.loading?.close();
    }, 200);
  }

  // ç”Ÿæˆuuid
  private static getUUID() {
    if (uuid) {
      return uuid;
    }
    uuid = Math.floor(Math.random() * 0xffffffffff).toString(16);
    localStorage.setItem('uuid', uuid);
    return uuid;
  }

  // å¤„ç†configï¼Œæ·»åŠ uuidå’Œtokenåˆ°headers
  protected handleRequestConfig(requestConfig) {
    if (!requestConfig.headers) requestConfig.headers = {};
    Token.exists() && (requestConfig.headers.authorization = `Bearer ${Token.get()}`);
    requestConfig.headers.uuid = PrimaryRequest.getUUID();
    return super.handleRequestConfig(requestConfig);
  }

  // é€šè¿‡æ•°ç»„ç”Ÿæˆmethod
  methodsWithUrl(methods: Method[], urlPrefix: string) {
    return methods.map((method) => this.simplifyMethodFactory(method, urlPrefix));
  }
}

// å¯¼å‡ºå…¬å…±çš„method
export const [Get, Post, Patch, Delete] = PrimaryRequest.ins.methodsWithUrl(
  ['get', 'post', 'patch', 'delete'],
  '',
);
```

### src/api/user.ts

user æ¨¡å—

```ts
import { PrimaryRequest } from '@/http/primary';

// å¤ç”¨urlå‰ç¼€
const urlPrefix = '/api/user';
const [Get, Post, Patch, Delete] = PrimaryRequest.ins.methodsWithUrl(
  ['get', 'post', 'patch', 'delete'],
  urlPrefix,
);

export interface User {
  id: number;
  nickname: string;
  avatar: string;
  username: string;
  loginAt: string;
  createAt: string;
  muted: boolean;
  deletedAt: string;
}
export function getSelf() {
  return Get<{ user: User }>('/self', {}, { silent: true });
}
export function deleteUser(id: string | number) {
  return Delete('/' + id);
}
export function restoreUser(id: string | number) {
  return Patch('/restore/' + id);
}
export function getUserAll() {
  return Get<{ list: User[]; count: number }>('');
}
export function getUserById(id: number | string) {
  return Get<User>('/' + id);
}
export function login(data: { username: string; password: string }) {
  return Post<{ token: string }>('/login', data);
}
export function register(data: {}) {
  return Post('/register', data);
}
export function updateUserInfo(userId: number | string, data: {}) {
  return Patch('/' + userId, data);
}
export function updatePassword(userId: number | string, data: {}) {
  return Patch('/password/' + userId, data);
}
export function muteUser(userId: number | string) {
  return Patch('/mute/' + userId);
}
export function cancelMuteUser(userId: number | string) {
  return Patch('/cancel-mute/' + userId);
}
```

### src/api/tag.ts

tag æ¨¡å—

```ts
import { Get, Post } from '@/http/primary';

const url = '/api/tag';

export interface Tag {
  createAt: string;
  description: string;
  id: number | string;
  name: string;
}

export function createTag(data: {}) {
  return Post(url, data);
}

export function getTags() {
  return Get<Tag[]>(url);
}
```

## åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ä½¿ç”¨

åœ¨å¾®ä¿¡å°ç¨‹åºä¸­ä½¿ç”¨ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤

1. å®‰è£…ä¾èµ–ï¼ˆ`npm install request-template`ï¼‰
2. ä½¿ç”¨å¼€å‘è€…å·¥å…·çš„`æ„å»ºnpm`åŠŸèƒ½
3. ä¿®æ”¹`primary.ts`å¹¶é‡å†™éƒ¨åˆ†æ–¹æ³•

   ```ts
   export class PrimaryRequest<
     CC extends PrimaryCustomConfig = PrimaryCustomConfig,
   > extends AxiosRequestTemplate<CC> {

    ...

     // è¦†ç›–åŸæœ‰çš„æ–¹æ³•
     // use $fetch
     protected init() {
       this.cache = new Cache();
     }

     // ä½¿ç”¨å°ç¨‹åºçš„å–æ¶ˆè¯·æ±‚åˆ¤æ–­é€»è¾‘
     protected isCancel(value: any) {
       return value?.errMsg === 'request:fail abort';
     }

     // ä½¿ç”¨å°ç¨‹åºçš„è¯·æ±‚æ–¹æ³•
     protected fetch(ctx) {
       const baseConfig = this.globalConfigs.requestConfig;
       const config = ctx.requestConfig;

       // è½¬æ¢æˆå°ç¨‹åºçš„è¯·æ±‚é…ç½®
       const method = config.method || baseConfig.method;
       return new Promise((resolve, reject) => {
         const task = wx.request({
           url: (config.baseURL || baseConfig.baseURL) + (config.url || baseConfig.url),
           method,
           data:
             method === 'get'
               ? { ...baseConfig.params, ...config.params }
               : { ...baseConfig.data, ...config.data },
           header: { ...baseConfig.headers, ...config.headers },
           success: resolve,
           fail: reject,
         });
         // æ³¨å†Œå–æ¶ˆäº‹ä»¶
         this.registerCanceler(ctx, task.abort.bind(task));
       }) as any;
     }

     // è¦†ç›–åŸæ¥çš„æ–¹æ³•
     // eslint-disable-next-line
     protected handleCanceler(_ctx) {}

     ...

   }
   ```

4. `token.ts`é‡å†™`token` `get` `set`

   ```ts
   export class Token {
     private static KEY = 'token';

     static set key(key: string) {
       Token.KEY = key;
     }
     static get key(): string {
       return Token.KEY;
     }

     static get(): string {
       return wx.getStorageSync(Token.KEY) || '';
     }
     static set(token: string) {
       wx.setStorageSync(Token.KEY, token);
     }

     static clear() {
       wx.removeStorageSync(Token.KEY);
     }
     static exists(): boolean {
       return !!Token.get();
     }
   }
   ```

å…¶ä»–å±‚é¢å¦‚`api`å±‚æ˜¯å®Œå…¨ä¸éœ€è¦æ”¹çš„ï¼Œè°ƒç”¨æ–¹å¼ä¹Ÿä¸€æ ·ä¸éœ€è¦æ”¹åŠ¨;

é¿å…äº†ç¯å¢ƒä¸€éå°±éœ€è¦åˆ°å¤„æŸ¥æ‰¾æ›´æ”¹ã€‚

## hooks

### useRequest

æ·»åŠ æ–‡ä»¶`hooks/useRequest.ts`

```plaintext
src
â”œâ”€â”€ api
|  â”œâ”€â”€ user.ts // å…·ä½“çš„api
|  â”œâ”€â”€ tag.ts // å…·ä½“çš„api
|  â””â”€â”€ ....
â”œâ”€â”€ http
|  â”œâ”€â”€â”€ primary // ä¸»è¯·æ±‚æ¨¡æ¿
|  |   â”œâ”€â”€ index.ts // è¯·æ±‚æ¨¡æ¿
|  |   â”œâ”€â”€ token.ts // tokenæ“ä½œå·¥å…·ç±»
|  |   â””â”€â”€ statusHandlers.ts // çŠ¶æ€å¤„ç†
|  â””â”€â”€â”€ other  // å…¶ä»–è§„åˆ™æ¨¡æ¿
|      â”œâ”€â”€ index.ts // è¯·æ±‚æ¨¡æ¿
|      â””â”€â”€ statusHandlers.ts // çŠ¶æ€å¤„ç†
â””â”€â”€ hooks // çŠ¶æ€å¤„ç†
    â”œâ”€â”€â”€ useRequset
```

`hooks/useRequest.ts`

```typescript
import { reactive, toRefs, isReactive, watch, isRef } from 'vue';
// import User from '@/api/User';

type FN = (...args: any[]) => Promise<any>;

interface State<T extends FN> {
  loading: boolean;
  data: Awaited<ReturnType<T>>['data'] | null;
  error: any | null;
}

type Options<A extends string, D extends object | void = void> = D extends void
  ? { requestAlias?: A; immediate?: boolean }
  : {
      immediate?: boolean;
      data?: D;
      dataDriver?: boolean;
    };

/**
 * è¯·æ±‚hooks
 *
 * @example
 *
 * // æ‰‹åŠ¨è¯·æ±‚ requestä¸å¸¦å‚æ•°
 * const res = useRequest(User.getSelf, { requestAlias: 'getSelf', immediate: true });
 * res.getSelf();
 * console.log(res.data.value?.user);
 *
 * const formModel = reactive({ username: '', password: '' });
 *
 * // æ‰‹åŠ¨è¯·æ±‚ requestå¸¦å‚æ•°
 * const res2 = useRequest(User.login);
 * res2.request(formModel);
 * console.log(res2.data.value?.token);
 *
 * formModel.username = '1';
 * formModel.password = '1';
 *
 * // æ•°æ®é©±åŠ¨
 * const res3 = useRequest(User.login, {
 *   data: formModel,
 *   immediate: true,
 *   dataDriver: true,
 * });
 * // res3.request(formModel); // error Property 'request' does not exist
 * // ä¿®æ”¹formModelè‡ªåŠ¨è§¦å‘è¯·æ±‚
 * formModel.username = '2';
 * formModel.password = '2';
 * console.log(res3.data.value?.token);
 *
 * @param  requestFn
 * @param  options
 * @param  defaultData
 */
export function useRequest<
  REQ extends FN,
  ALIAS extends string = 'request',
  DATA extends object | void = void,
>(
  requestFn: REQ,
  options: Options<ALIAS, DATA> = {} as any,
  defaultData: Awaited<ReturnType<REQ>>['data'] | null = null,
) {
  const state = reactive<State<REQ>>({
    loading: false,
    data: defaultData,
    error: null,
  });

  const refs = toRefs(state);

  const request = (...args: any[]) => {
    // computedå˜é‡ä¸èƒ½JSON.stringfy
    args = args.map((item) => (isRef(item) ? item.value : item));
    state.loading = true;
    requestFn(...args)
      .then(
        (res) => {
          state.data = res.data;
        },
        (err) => (state.error = err),
      )
      .finally(() => {
        state.loading = false;
      });
  };

  const {
    requestAlias = 'request',
    immediate = false,
    data,
    dataDriver = false,
  } = options as Options<ALIAS, {}> & Options<ALIAS>;

  // æ•°æ®é©±åŠ¨
  if (dataDriver && data && (isReactive(data) || isRef(data))) {
    watch(
      data,
      (n) => {
        request(n);
      },
      { deep: true },
    );
  }

  if (immediate) {
    request(data);
  }

  return {
    ...refs,
    // æ•°æ®é©±åŠ¨æ—¶as anyä¸€ä¸‹è¿˜æ˜¯èƒ½ç”¨çš„
    [requestAlias]: request,
  } as typeof refs &
    (DATA extends void
      ? { [k in keyof Record<ALIAS, void>]: (...args: Parameters<REQ>) => void }
      : void);
}
```

`useRequest`åˆ†ä¸º`æ•°æ®é©±åŠ¨`å’Œ`æ™®é€šè¯·æ±‚`ä¸¤ç§æ–¹å¼ã€‚å¦‚æœä½ çš„è¯·æ±‚æ˜¯æ¯æ¬¡æ•°æ®æ”¹åŠ¨å°±è¯·æ±‚ï¼Œé‚£ä¹ˆå¯ä»¥ä½¿ç”¨`æ•°æ®é©±åŠ¨`ï¼Œå¦åˆ™å¯ä»¥`ç«‹å³`æˆ–`æ‰‹åŠ¨`è¯·æ±‚

### ä½¿ç”¨useRequest
è·å–æ–‡ç« åˆ—è¡¨ã€‚

æ·»åŠ `api/article.ts`
```typescript
import type User from './User';
import { Get } from '@/http/primary';

export interface Article {
  author: User;
  categoryId: number;
  content: string;
  cover: string;
  createAt: string;
  description: string;
  id: number;
  status: number;
  title: string;
  updateAt: string;
  viewCount: number;
  commentLock: boolean;
  commentCount?: number;

  like: { count: number; checked: number };
}

export interface GetArticleListRes {
  list: Article[];
  count: number;
}
export function getArticleList(data: {}) {
  return Get<GetArticleListRes>('/api/article', data, { cache: true });
}
```

æ•°æ®é©±åŠ¨ï¼šæ ¹æ®è·¯ç”±å˜åŒ–è·å–æ•°æ®
```html
<script setup lang="ts">
import { useRequest } from '@/hooks/useRequest';
import { useRoute, useRouter } from 'vue-router';
import { getArticleList } from '@/api/article';
import { computed, watch } from 'vue';

const route = useRoute();
const router = useRouter();

// pagination handler
const onPageChange = (page: number) => {
  const query: any = { ...route.query };
  query.page = page;
  router.replace({ path: route.path, query });
};

// åªè¦è·¯ç”±å˜åŒ–å°±ä¼šæ›´æ–°params
const params = computed(() => {
  const q = route.query;
  return {
    keyword: q.query || '',
    sort: q.sort ? Number(q.sort) : 3,
    category: q.cate ? Number(q.cate) : '',
    tag: ((q.tag as string) || '').split(',').filter(Boolean).map(Number),
    page: q.page ? Number(q.page) : 1,
  };
});

// ä¼šæ ¹æ®paramså˜åŒ–è‡ªåŠ¨è¯·æ±‚åˆ—è¡¨æ•°æ®ï¼Œä¸éœ€è¦å†æ‰‹åŠ¨è°ƒç”¨
const { data, loading } = useRequest(getArticleList, { data: params });
watch(loading, () => {
  console.log(data.value?.list, data.value?.count);
});
</script>
```

# ç»“å°¾

å¦‚æœæœ‰é”™æ¬¢è¿æŒ‡å‡º...
å¦‚æœæ–‡ç« ã€åº“å¯¹ä½ æœ‰å¸®åŠ©ï¼Œé‚£ä¹ˆè¯·è®°å¾—ç‚¹èµæˆ– star å“¦ ğŸ˜¬
