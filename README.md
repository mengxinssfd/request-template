# request-template

## å‰è¨€

å…³äº axios çš„å°è£…ä¸èƒœæšä¸¾ã€‚

ä½†çœ‹ä¸Šå»å¤§éƒ¨åˆ†éƒ½æ˜¯å•ç‹¬çš„å‡½æ•°ï¼šå¦‚å•ç‹¬çš„å–æ¶ˆè¯·æ±‚ï¼Œç¼“å­˜ï¼Œè‡ªåŠ¨å¸¦ä¸Š token ç­‰ç­‰ã€‚

ç»“æ„è¿‡äºæ¾æ•£ï¼Œä¸å¤Ÿå°è£…ï¼Œéœ€è¦ç”¨æˆ·æ‰‹åŠ¨å¤åˆ¶è¿‡æ¥ï¼Œè¿‡äºéº»çƒ¦ï¼Œä¸”ä¸€æ—¦ä¸šåŠ¡æ”¹äº†åˆå¾—é‡å†™ä¸€å †ï¼›åˆæˆ–å°è£…äº†ä½†æ‰©å±•æ€§å¤ªä½ï¼Œæ— æ³•æ ¹æ®ä¸šåŠ¡è°ƒæ•´è€Œè°ƒæ•´ã€‚

ç¼ºä¹å…³äºä¸€æ•´å¥—å®Œæ•´çš„æ–¹æ¡ˆã€‚

## github request-template

é’ˆå¯¹ä»¥ä¸Šé—®é¢˜ï¼Œæˆ‘å®ç°äº†è¯¥åº“[`request-template`](https://github.com/mengxinssfd/request-template)ã€‚

åŸºäº `axios` çš„è¯·æ±‚å°è£…ï¼Œè¯¥åº“ä½¿ç”¨æ¨¡æ¿æ–¹æ³•æ¨¡å¼å®ç°ï¼Œæ¯ä¸€ä¸ªæ­¥éª¤éƒ½å¯ä»¥è¢«å­ç±»è¦†ç›–æ–¹ä¾¿æ‰©å±•ï¼Œé…ç½®å¯å¤ç”¨ã€‚

ä½ ä¹Ÿå¯ä»¥ä½¿ç”¨`fetch`æ¥è¯·æ±‚ï¼Œåªéœ€è¦é‡å†™ä½¿ç”¨åˆ°`axios`çš„å…³é”®æ­¥éª¤ã€‚

è¿™ä¸æ˜¯ä¸€ä¸ªæœ€ç»ˆæ–¹æ¡ˆï¼Œä¸æ˜¯è¯´ç”¨äº†è¿™ä¸ªåº“å°±èƒ½ä»€ä¹ˆéƒ½ä¸ç”¨å†™äº†ï¼Œä½†å®ƒèƒ½æå¤§å‡å°‘ä½ çš„ä»£ç å¤æ‚åº¦ï¼Œæé«˜ä»£ç çš„å¤ç”¨æ€§ï¼Œä¸ºä½ çš„æœ€ç»ˆæ–¹æ¡ˆæä¾›æ”¯æŒã€‚

é¢å‘ç»§æ‰¿å¼€æ”¾ï¼Œé¢å‘ä½¿ç”¨å…³é—­ã€‚

å°è£…ä½†ä¸å°é—­

åœ°å€ï¼š[https://github.com/mengxinssfd/request-template](https://github.com/mengxinssfd/request-template)

æ¬¢è¿ starã€issueã€pr

## ä¸»è¦å®ç°

- [X]  éä¾µå…¥å¼€æ”¾å¼å°è£…
  - [X]  å¯¹äºç»§æ‰¿æ‰©å±•å¼€æ”¾
  - [X]  å¯¹äºä½¿ç”¨æ—¶ä¿®æ”¹å…³é—­
- [X]  æ¨¡æ¿æ–¹æ³•æ¨¡å¼å®ç°
  - [X]  å¯å®ç°è‡ªå®šä¹‰æ¨¡æ¿
  - [X]  å¯ç»§æ‰¿å¤ç”¨åŸºç¡€æ¨¡æ¿
- [X]  å¤šå®ä¾‹
- [X]  ts ç±»å‹æ”¯æŒ
  - [X]  èŒƒå‹æ”¯æŒ
  - [X]  åŸ axios ç±»å‹æ”¯æŒ
- [X]  å¤šçŠ¶æ€å¤„ç†
- [X]  æ¥å£ç¼“å­˜
  - [X]  è‡ªå®šä¹‰ç¼“å­˜å‘½ä¸­è§„åˆ™
- [X]  é…ç½®
  - [X]  å…¨å±€é…ç½®(ä¿æŒç»Ÿä¸€ï¼Œå¤ç”¨é…ç½®)
  - [X]  å±€éƒ¨é…ç½®(æ”¯æŒä¸ªæ€§åŒ–é…ç½®{æŸäº›ä¸æŒ‰è§„èŒƒå®ç°çš„æ¥å£})
- [X]  é…ç½®å¤ç”¨
  - [X]  å®ä¾‹çº§å¤ç”¨
  - [X]  api çº§å¤ç”¨
- [X]  å–æ¶ˆè¯·æ±‚
  - [X]  å–æ¶ˆå•ä¸ªè¯·æ±‚
  - [X]  æ ¹æ® tag å–æ¶ˆè¯·æ±‚
  - [X]  å–æ¶ˆæ‰€æœ‰è¯·æ±‚
- [X]  è¯·æ±‚å¤±è´¥é‡è¯•
  - [X]  é‡è¯•æ¬¡æ•°
  - [X]  å»¶æ—¶é‡è¯•
  - [X]  ç¬¬ä¸€æ¬¡é‡è¯•ç«‹å³å¯åŠ¨ï¼ˆå¯é€‰ï¼‰
  - [X]  ä¸­æ–­é‡è¯•

## ç”Ÿå‘½å‘¨æœŸ

```mermaid
flowchart
MergeConfig[fa:fa-spinner åˆå¹¶é…ç½®]
CreateTemplate[fa:fa-spinner åˆ›å»ºæ¨¡æ¿new AxiosRequestTemplate]
GlobalRequestConfig[å…¨å±€è¯·æ±‚é…ç½®]
GlobalCustomConfig[å…¨å±€è‡ªå®šä¹‰é…ç½®]


CreateTemplate --> GlobalRequestConfig --> templateå®ä¾‹
CreateTemplate --> GlobalCustomConfig --> templateå®ä¾‹


templateå®ä¾‹ --> request


request --> MergeConfig --> è¯·æ±‚å¼€å§‹ --> æ·»åŠ Canceleré’©å­ --> ä½¿ç”¨ç¼“å­˜?

æ·»åŠ Canceleré’©å­ --> è¿™ä¸€æ­¥åæ‰å¯ä»¥æ‰§è¡Œå–æ¶ˆhandler

ä½¿ç”¨ç¼“å­˜? --> |æ˜¯| retryä¸­?
retryä¸­? --> |å¦| å‘½ä¸­ç¼“å­˜?
retryä¸­? --> |æ˜¯| è¯·æ±‚


å‘½ä¸­ç¼“å­˜?  --> |æ˜¯| ä½¿ç”¨ç¼“å­˜ --> è¯·æ±‚æˆåŠŸ?
å‘½ä¸­ç¼“å­˜?  --> |å¦| è¯·æ±‚

ä½¿ç”¨ç¼“å­˜? --> |å¦| è¯·æ±‚ -->  ç¼“å­˜è¯·æ±‚  --> è¯·æ±‚æˆåŠŸ?


è¯·æ±‚æˆåŠŸ? --> |æ˜¯| å¤„ç†è¯·æ±‚ç»“æœ
è¯·æ±‚æˆåŠŸ? --> |å¦| è¯·æ±‚è¢«å–æ¶ˆ? --> |æ˜¯| æ¸…ç†è¯¥è¯·æ±‚ç¼“å­˜ --> ç»“æŸretry --> è¯·æ±‚å®Œæˆ
è¯·æ±‚è¢«å–æ¶ˆ? --> |å¦| retry?

retry? --> |å¦| å¤„ç†è¯·æ±‚ç»“æœ
retry? --> |æ˜¯| æ·»åŠ æ¸…ç†é’©å­ --> è¯·æ±‚å¼€å§‹


å¤„ç†è¯·æ±‚ç»“æœ --> å¤„ç†çŠ¶æ€ --> è¯·æ±‚å®Œæˆ --> æ¸…ç†é’©å­





```

## å®‰è£…

å¯ä»¥ä½¿ç”¨`npm` `cnpm` `yarn` `pnpm`ç­‰æ–¹å¼å®‰è£…ï¼Œæ¨èä½¿ç”¨`pnpm`å®‰è£…å‡å°‘`node_module`ä½“ç§¯

```shell
pnpm add request-template
```

## åŸºç¡€ç”¨æ³•ï¼ˆä½¿ç”¨é»˜è®¤æ¨¡æ¿ï¼‰

### é›¶é…ç½®ç›´æ¥ä½¿ç”¨

è¿™æ—¶çº¦ç­‰äº`axios({url})`

```ts
// newä¸€ä¸ªå®ä¾‹
const template = new AxiosRequestTemplate();

// request<T = never, RC extends boolean = false>(requestConfig: Omit<AxiosRequestConfig, 'cancelToken' | 'url'> & {
//        url: string;
//    }, customConfig?: DynamicCustomConfig<CC, RC>): Promise<RC extends true ? AxiosResponse<ResType<T>> : ResType<T>>;

// `request`æ”¯æŒ2ä¸ªå‚æ•°åˆ†åˆ«æ˜¯`axios`çš„è¯·æ±‚è®¾ç½®`requestConfig`ä»¥åŠï¼Œè‡ªå®šä¹‰è®¾ç½®çš„`customConfig`
// `requestConfig`ä¸º`axios`åŸè®¾ç½®
// `request`é»˜è®¤ä¸º`get`è¯·æ±‚
template.request({ url: '/test', params: { param1: 1, param2: 2 } }).then((res) => {
  console.log(res);
});
// `post`è¯·æ±‚ï¼Œ`delete` `patch`ä¹Ÿæ˜¯ä»¥æ­¤ç±»æ¨
template.request({ url: '/test', data: { param1: 1, param2: 2 }, method: 'post' }).then((res) => {
  console.log(res);
});
```

### ä½¿ç”¨`methodFactory`æ–¹æ³•ç”Ÿæˆä¸€ä¸ª`method`å‡½æ•°

ä¸Šé¢ä½¿ç”¨æ¯æ¬¡éƒ½è¦è®¾ç½®`method`æœ‰äº›éº»çƒ¦äº†ï¼Œå¯ä»¥ç”¨`methodFactory`å‡½æ•°ç”Ÿæˆä¸€ä¸ª`method`å‡½æ•°ç®€åŒ–ä¸€ä¸‹

```ts
// 'post','get','patch'...
const post = template.methodFactory('post');
post({ url: '/test', data: { param1: 1, param2: 2 } }).then((res) => {
  console.log(res);
});
post({ url: '/test', data: { param1: 1, param2: 2 } }).then((res) => {
  console.log(res);
});
```

æ³¨æ„ï¼š`methodFactory`ç”Ÿæˆçš„ `method`å‡½æ•°ä¸ `request`å‚æ•°è¿”å›å€¼ä¸€è‡´ï¼Œä¸” `requestConfig`é‡Œçš„ `method`å±æ€§ä¸å†èµ·ä½œç”¨

è¯¥æ–¹æ³•ç¬¬äºŒä¸ªå‚æ•°æ¥æ”¶ä¸€ä¸ª`handler`å¯ä»¥å¯¹é…ç½®è¿›è¡Œä¸€äº›å¤„ç†ï¼Œå¦‚è®¾ç½®ä¸€äº›å…¬å…± url å‰ç¼€ç­‰ã€‚

### ä½¿ç”¨ç¼“å­˜

å‘½ä¸­ç¼“å­˜æ—¶ï¼Œè¯¥æ¬¡è¯·æ±‚ç»“æœä¼šç›´æ¥ä»ç¼“å­˜ä¸­æ‹¿ï¼Œä¸ä¼šå‘èµ·æ–°çš„è¯·æ±‚ï¼Œè¢«å–æ¶ˆçš„è¯·æ±‚ä¸ä¼šè¿›å…¥ç¼“å­˜

#### é»˜è®¤ 5 ç§’å†…ä½¿ç”¨ç¼“å­˜

```ts
export function login(data: { username: string; password: string }) {
  // 5ç§’å†…éƒ½ä¼šæ˜¯åŒæ ·çš„æ•°æ®
  return post<{ token: string }>({ url: '/user/login', data }, { cache: true });
}
```

æ³¨æ„ï¼šå› é¿å…ä½¿ç”¨è¿‡é•¿çš„ç¼“å­˜æ—¶é—´ï¼Œå¦åˆ™æœ‰å†…å­˜æº¢å‡ºçš„é£é™©ã€‚

#### è‡ªå®šä¹‰è¿‡æœŸæ—¶é—´

```ts
export function login(data: { username: string; password: string }) {
  // timeoutå•ä½ä¸ºæ¯«ç§’
  return post<{ token: string }>(
    { url: '/user/login', data },
    { cache: { timeout: 30 * 60 * 1000 } },
  );
}
```

### å–æ¶ˆè¯·æ±‚

å¾ˆå¤šäººä¸çŸ¥é“å–æ¶ˆè¯·æ±‚çš„ä½œç”¨ï¼Œè¯´ä»€ä¹ˆåç«¯è¿˜æ˜¯ä¼šæ”¶åˆ°è¯·æ±‚ï¼Œè¯·æ±‚è¿˜æ˜¯å‘å‡ºå»äº†ä»€ä¹ˆçš„ã€‚

å…¶å®é‚£äº›æˆ‘ä»¬å®Œå…¨ä¸éœ€è¦å…³å¿ƒï¼Œ

æˆ‘ä»¬åªéœ€è¦å…³å¿ƒï¼šä¸è¦å†å¤„ç†æ¥å£åç»­ï¼Œä¹Ÿå°±æ˜¯è¯´é‚£äº›æ¥å£ä¸ç®¡æˆä¸æˆåŠŸé‚£äº›ç»“æœæˆ‘éƒ½ä¸è¦äº†ï¼Œè¿™å°±æ˜¯å–æ¶ˆè¯·æ±‚çš„æ„ä¹‰

#### å–æ¶ˆå½“å‰è¯·æ±‚

å–æ¶ˆå‡½æ•°çš„æ—¶æœºå¾ˆé‡è¦ï¼Œå¿…é¡»åœ¨ requestã€getã€post ç­‰è¯·æ±‚æ–¹æ³•æ‰§è¡Œåè·å–çš„å–æ¶ˆå‡½æ•°æ‰æ˜¯æœ‰æ•ˆçš„ï¼Œè€Œä¸”å¿…é¡»ä½¿ç”¨å¯¹åº”çš„å®ä¾‹æ¥å–æ¶ˆè¯·æ±‚

```ts
const req = login({ username: 'test', password: 'test' });
// å¿…é¡»ä½¿ç”¨å¯¹åº”çš„å®ä¾‹æ¥å–æ¶ˆè¯·æ±‚
template.cancelCurrentRequest('cancel message');
try {
  await req;
} catch (e: { message: string }) {
  // ä¼šæ•è·è¯¥æŠ¥é”™
  // message: "cancel message"
}
```

ä½¿ç”¨è¯¥æ–¹æ³•å¯ä»¥å–æ¶ˆå¤±è´¥é‡è¯•ï¼Œä½†ç”±äºæ—¶æœºéš¾ä»¥ç¡®å®šï¼Œå½“å‰è¯·æ±‚å¯èƒ½å…¶ä»–è¯·æ±‚ï¼Œæ‰€ä»¥ä¸æ¨èä½¿ç”¨å®ƒå–æ¶ˆé‡è¯•

#### å–æ¶ˆæ‰€æœ‰è¯·æ±‚

```ts
const req = login({ username: 'test', password: 'test' });
// æˆ–è€…
template.cancelAll('cancel message');
try {
  await req;
} catch (e: { message: string }) {
  // ä¼šæ•è·è¯¥æŠ¥é”™
  // message: "cancel message"
}
```

å¯ä»¥å–æ¶ˆé‡è¯•ï¼Œä½†èŒƒå›´å¤ªå¤§ï¼Œå¯èƒ½ä¼šè¯¯ä¼¤å…¶ä»–è¯·æ±‚

#### æ ¹æ®`tag`å–æ¶ˆè¯·æ±‚

```ts
export function login(data: { username: string; password: string }) {
  // timeoutå•ä½ä¸ºæ¯«ç§’
  return post<{ token: string }>('/user/login', data, { tag: 'cancelable' });
}
```

```ts
const req = login({ username: 'test', password: 'test' });
template.cancelWithTag('cancelable', 'cancel message');
try {
  await req;
} catch (e: { message: string }) {
  // ä¼šæ•è·è¯¥æŠ¥é”™
  // message: "test"
}
```

ä½¿ç”¨`tag`æ–¹å¼å–æ¶ˆå¾ˆæ–¹ä¾¿çµæ´»ä¸”å®ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥åœ¨è¯·æ±‚å‰å–æ¶ˆç›¸åŒ`tag`çš„è¯·æ±‚ï¼›

æˆ–è€…å¤ç”¨æ¨¡æ¿æ—¶æ‰€æœ‰è¯·æ±‚è®¾ç½®ä¸€ä¸ªé»˜è®¤`tag`ï¼Œç„¶åæŸä¸€ä¸ªè¯·æ±‚è®¾ç½®ä¸ºä¸ä¸€æ ·çš„`tag`ï¼Œä»è€Œå®ç°åå‘`tag`å–æ¶ˆçš„åŠŸèƒ½

è¿˜èƒ½å–æ¶ˆæ­£åœ¨æ‰§è¡Œä¸­çš„å¤±è´¥é‡è¯•

### å¤±è´¥é‡è¯•

#### é‡è¯•

é‡è¯• 3 æ¬¡ï¼Œ`http`çŠ¶æ€ç é`200`æ—¶ä¼šé‡è¯• 3 æ¬¡

```ts
try {
  await post({ url: '/retry' }, { retry: 3 });
} catch (e: any) {
  // ä¼šæ•è·æœ€åä¸€æ¬¡è¯·æ±‚çš„é”™è¯¯
}
```

#### é‡è¯•é—´éš”

æ¯æ¬¡é‡è¯•é—´éš” 3 ç§’, `interval`ç¼ºçœæ—¶ä¸º 0 ç§’ï¼Œä¹Ÿå°±æ˜¯è¯´æ¯æ¬¡éƒ½æ˜¯`setTimeout(request, undefined))`è¯·æ±‚

```ts
try {
  await post({ url: '/retry' }, { retry: { times: 3, interval: 3000 } });
} catch (e: any) {
  // ä¼šæ•è·æœ€åä¸€æ¬¡è¯·æ±‚çš„é”™è¯¯
}
```

#### ç¬¬ä¸€æ¬¡é‡è¯•é›¶é—´éš”

æ¯æ¬¡é‡è¯•é—´éš” 3 ç§’, ç¬¬ä¸€æ¬¡é‡è¯•é›¶é—´éš”ï¼Œä¹Ÿå°±æ˜¯è¯´ç¬¬ä¸€æ¬¡é‡è¯•æ˜¯`setTimeout(request, undefined))`è¯·æ±‚

```ts
try {
  await post({ url: '/retry' }, { retry: { times: 3, interval: 3000, immediate: true } });
} catch (e: any) {
  // ä¼šæ•è·æœ€åä¸€æ¬¡è¯·æ±‚çš„é”™è¯¯
}
```

#### å–æ¶ˆé‡è¯•

é”™è¯¯çš„æ–¹å¼

```ts
const req = post({ url: '/retry' }, { retry: 3 });
const cancel = template.cancelCurrentRequest;
cancel(); // é”™è¯¯ï¼Œç”±äº`cancelCurrentRequest`ä¼šè®°ä½å½“å‰è¯·æ±‚ï¼Œæ­¤æ—¶æ— æ³•ç¡®å®šå½“å‰æ˜¯å“ªä¸ªè¯·æ±‚
try {
  await req;
  // do something
} catch (e) {
  // do something
}
```

ç”±äº`cancelCurrentRequest`ä¼šè®°ä½æ­¤æ—¶æ— æ³•ç¡®å®šå½“å‰æ˜¯å“ªä¸ªè¯·æ±‚ï¼Œè™½ç„¶å¯ä»¥ç›´æ¥è°ƒç”¨`template.cancelCurrentRequest()`ï¼Œä½†æ˜¯å¦‚æœè¯·æ±‚å¤šçš„è¯ï¼Œå¯èƒ½ä¼šè¯¯ä¼¤å…¶ä»–è¯·æ±‚ã€‚

æ‰€ä»¥æœ€å¥½çš„åŠæ³•æ˜¯ä½¿ç”¨`tag`æ–¹å¼å–æ¶ˆè¯·æ±‚ï¼š

æ­£ç¡®çš„æ–¹å¼

```ts
const symbol = Symbol('cancel'); // å¯ä»¥ä½¿ç”¨å­—ç¬¦ä¸²ï¼Œä½†æ˜¯ç”¨Symbolå¯ä»¥è®©tagä¸ä¼šä¸ä»»ä½•tagé‡å¤
const req = post({ url: '/retry' }, { retry: 3, tag: symbol });
template.cancelWithTag(symbol, 'msg');
try {
  await req;
  // do something
} catch (e) {
  // do something
}
```

### å¤šçŠ¶æ€å¤„ç†

ä½¿ç”¨é»˜è®¤æ¨¡æ¿æ—¶éœ€è¦åå°æ•°æ®ç»“æ„ä¸º`{data:any; code: number; msg: string;}`

è¯·æ±‚çº§çŠ¶æ€å¤„ç†æ›´å¤šæ—¶å€™æ˜¯ä½œä¸ºä¸€ç§è¡¥å……ï¼Œå¸¸ç”¨çŠ¶æ€å¤„ç†æ¨èå†™åˆ°`è‡ªå®šä¹‰æ¨¡æ¿`+`å…¨å±€é…ç½®`ä¸Š

```ts
post(
  '/login',
  {},
  {
    statusHandlers: {
      // codeä¸º200æ—¶è°ƒç”¨
      200(_, res, data) {
        // do something
      },
      // codeä¸º20æ—¶è°ƒç”¨
      20(_, res, data) {
        // do something
      },
    },
  },
);
```

### å…¨å±€é…ç½®

```ts
import { AxiosRequestTemplate } from './AxiosRequestTemplate';

const template = new AxiosRequestTemplate({
  // AxiosRequestConfig axiosé…ç½®
  requestConfig: { data: { a: 1 }, params: { a: 1 } },
  // è‡ªå®šä¹‰é…ç½®
  customConfig: {
    tag: 'cancelable',
    retry: { times: 3, interval: 3000, immediate: true },
    statusHandlers: {
      // codeä¸º200æ—¶è°ƒç”¨
      200(_, res, data) {
        // do something
      },
      // codeä¸º20æ—¶è°ƒç”¨
      20(_, res, data) {
        // do something
      },
    },
    cache: { timeout: 30 * 60 * 1000, enable: true },
  },
});
```

```ts
const post = template.methodFactory('post');
post('/test').then((res) => {
  // do something
});
```

æ­¤æ—¶çš„æ¯æ¬¡è¯·æ±‚éƒ½ä¼šä½¿ç”¨ç¼“å­˜ï¼Œå¸¦ä¸Š`tag`ï¼Œä½¿ç”¨çŠ¶æ€å¤„ç†ï¼Œå¤±è´¥é‡è¯•ï¼Œ `data`æˆ–`params`ä¼šå¸¦ä¸Š`{a:1}`ï¼Œ

`cache`æœ‰ä¸€ä¸ªå°æŠ€å·§ï¼Œå¯ä»¥å…ˆè®¾ç½®`{ timeout: 30 * 60 * 1000, enable: false }`ï¼ŒæŠŠ`enable`è®¾ç½®ä¸º`false`ï¼Œåªè®¾ç½®`timeout`

ç„¶åè¯·æ±‚æ—¶ï¼ŒæŠŠ`cache`è®¾ç½®ä¸º`true`ï¼Œé‚£ä¹ˆå°±å¯ä»¥å…¨å±€ä¸ä½¿ç”¨ç¼“å­˜ï¼Œåªä½¿ç”¨ç¼“å­˜æ—¶é—´ï¼Œè¯·æ±‚æ—¶å†å¼€å¯è¯·æ±‚ç¼“å­˜åŠŸèƒ½

```ts
post({ url: '/test' }, { cache: true }).then((res) => {
  // do something
});
```

## å®é™…åœºæ™¯åŠè§£å†³æ–¹æ¡ˆ

### å…¨å±€è¯·æ±‚`loading`

ä»¥`elementPlus`ä¸ºä¾‹ï¼Œå…·ä½“å¯ä»¥ä½¿ç”¨è‡ªå·±å–œæ¬¢çš„ ui åº“å®ç°ï¼Œè¯¥å®ç°éœ€è¦è‡ªå®šä¹‰æ¨¡æ¿

```ts
import { ElLoading, ILoadingInstance } from 'element-plus';
import { AxiosRequestTemplate, Context, CustomConfig } from 'request-template';

interface MyConfig extends CustomConfig {
  loading?: boolean;
}

class RequestWithLoading<CC extends MyConfig = MyConfig> extends AxiosRequestTemplate<CC> {
  private loading?: ILoadingInstance;

  protected beforeRequest(ctx: Context<CC>) {
    super.beforeRequest(ctx); // å¤ç”¨åŸºç¡€æ¨¡æ¿é€»è¾‘
    if (ctx.customConfig.loading) {
      this.loading = ElLoading.service({ fullscreen: true });
    }
  }

  protected afterRequest(ctx) {
    super.afterRequest(ctx); // å¤ç”¨åŸºç¡€æ¨¡æ¿é€»è¾‘
    // åŠ ä¸ªå®šæ—¶å™¨é¿å…è¯·æ±‚å¤ªå¿«ï¼Œloadingä¸€é—ªè€Œè¿‡
    setTimeout(() => {
      this.loading?.close();
    }, 200);
  }
}
```

```ts
// å¯ä»¥é…ç½®é»˜è®¤æ˜¯å¼€å¯è¿˜æ˜¯å…³é—­ï¼Œæ­¤ä¾‹å­é»˜è®¤æ‰€æœ‰çš„éƒ½å¼€å¯
const req = new RequestWithLoading({}, { loading: true });

const get = req.simplifyMethodFactory('get');

// æ­¤æ—¶æ‰€æœ‰çš„è¯·æ±‚éƒ½å¯ä»¥å¸¦ä¸Šloading
get('/test');
get('/test');

// å•ç‹¬æŸä¸ªè¯·æ±‚ä¸ä½¿ç”¨`loading`
get('/test', {}, { loading: false });
```

æ³¨æ„ï¼š`elementPlus`ä¾‹å­å¤šæ¬¡è°ƒç”¨`loading`å¹¶ä¸ä¼šæ‰“å¼€å¤šä¸ª`loading`

> éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œä»¥æœåŠ¡çš„æ–¹å¼è°ƒç”¨çš„å…¨å± Loading æ˜¯å•ä¾‹çš„ã€‚ è‹¥åœ¨å‰ä¸€ä¸ªå…¨å± Loading å…³é—­å‰å†æ¬¡è°ƒç”¨å…¨å± Loadingï¼Œå¹¶ä¸ä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„ Loading å®ä¾‹ï¼Œè€Œæ˜¯è¿”å›ç°æœ‰å…¨å± Loading çš„å®ä¾‹

å¦‚æœä½ çš„`loading`ä¸æ˜¯å•ä¾‹çš„ï¼Œé‚£ä¹ˆä½ éœ€è¦è‡ªå·±å¤„ç†ä¸€ä¸‹å¤šä¸ª`loading`å­˜åœ¨å¯èƒ½å¯¼è‡´çš„é—®é¢˜

### å…¨å±€è¯·æ±‚å¸¦ä¸Š`token`

`token`æ“ä½œå°è£…ï¼Œé»˜è®¤ä¿å­˜åˆ°`localStorage`,å¯ä»¥æŒ‰ç…§è‡ªå·±å–œæ¬¢ä¿å­˜åˆ°`sectionStorage`æˆ–`cookie`ä¸Š

```ts
export class Token {
  private static KEY = 'token';

  static set key(key: string) {
    Token.KEY = key;
  }
  static get key(): string {
    return Token.KEY;
  }

  static get(): string {
    return localStorage.getItem(Token.KEY) || '';
  }
  static set(token: string) {
    localStorage.setItem(Token.KEY, token);
  }

  static clear() {
    localStorage.removeItem(Token.KEY);
  }
  static exists(): boolean {
    return !!Token.get();
  }
}
```

çŠ¶æ€ç ä¸º`401`æ—¶æ¸…é™¤`token`, çŠ¶æ€ç ä¸º`207`æ—¶ä¿å­˜`token`,

```ts
import { StatusHandlers } from 'request-template';
export const statusHandlers: StatusHandlers = {
  401: (ctx, res, data) => {
    Token.clear();
    return Promise.reject(data);
  },
  207: ({ customConfig }, res, data) => {
    data.data.token && Token.set(data.data.token);
    return customConfig.returnRes ? res : data;
  },
};
```

å¦‚æœ`token`æ˜¯æ”¾ç½®åœ¨`headers`ï¼Œé‚£ä¹ˆåœ¨è®¾ç½®`axios`é…ç½®æ—¶é¡ºå¸¦é…ç½®å¥½`headers`

```ts
export class PrimaryRequest extends AxiosRequestTemplate {
  protected handleRequestConfig(url, requestConfig) {
    if (!requestConfig.headers) requestConfig.headers = {};
    Token.exists() && (requestConfig.headers.authorization = `Bearer ${Token.get()}`);
    return super.handleRequestConfig(url, requestConfig);
  }
}
```

å¦‚æœ`token`æ˜¯æ”¾ç½®åœ¨`data`ï¼Œé‚£ä¹ˆåœ¨è®¾ç½®`axios`é…ç½®æ—¶é¡ºå¸¦é…ç½®å¥½`data`

è‡ªå®šä¹‰æ¨¡æ¿

```ts
export class PrimaryRequest extends AxiosRequestTemplate {
  protected handleRequestData(ctx, data) {
    if (Token.exists()) {
      data.token = Token.get();
    }
    super.handleRequestData(ctx, data);
  }
}
```

ä¹Ÿå¯ä»¥æƒ³å¾ˆå¤šäººé‚£æ ·è®¾ç½®åœ¨æ‹¦æˆªå™¨ä¸Šï¼Œä¸è¿‡ä¸ªäººä¸æ˜¯å¾ˆæ¨èï¼Œè¿™æ ·æœ‰ç‚¹ä¸å¤ªå¥½ç†è§£

```ts
export class PrimaryRequest extends AxiosRequestTemplate {
  protected setInterceptors() {
    this.interceptors.request.use((requestConfig) => {
      if (!requestConfig.headers) requestConfig.headers = {};
      Token.exists() && (requestConfig.headers.authorization = `Bearer ${Token.get()}`);
    });
  }
}
```

### é¡µé¢é¢‘ç¹æ“ä½œæ•°æ®ç¼“å­˜

> æ¯”å¦‚åœ¨ä¸€ä¸ªåˆ—è¡¨é¡µé¢ï¼Œå¯ä»¥é€‰æ‹©åˆ†ç±»ä»¥åŠæ ‡ç­¾ï¼Œè¿˜æœ‰æ’åºæ–¹å¼ï¼ˆå…¶å®å°±æ˜¯æˆ‘çš„åšå®¢ ğŸ˜„ï¼‰ã€‚
> è¿™äº›å¯æ“ä½œåŒºåŸŸå¯èƒ½ä¼šç»å¸¸ç‚¹æ¥ç‚¹å»ï¼Œä½†æ˜¯å…¶å®æ•°æ®ä¸ä¼šåˆ·æ–°é‚£ä¹ˆå¿«ï¼Œå¾ˆå®¹æ˜“äº§ç”Ÿå†—ä½™çš„æ•°æ®ï¼Œæˆ‘ä»¬å®Œå…¨å¯ä»¥æŠŠæ•°æ®ç¼“å­˜èµ·æ¥ã€‚

```ts
const req = new AxiosRequestTemplate();

// api
export function getArticleList(params: { cate: number; tags: number[]; sort: number; p: number }) {
  req.cancelWithTag(tag);
  return req.request({ url: '/api/article', params }, { cache: true });
}
```

ç„¶ååªè¦`{url,headers,data,method}`è¿™äº›å‚æ•°æ˜¯ä¸€æ ·çš„è¯å°±ä¸ä¼šå‘èµ·è¯·æ±‚äº†ï¼Œè€Œæ˜¯ç›´æ¥ä»ç¼“å­˜ä¸­æ‹¿æ•°æ®ï¼Œä¸è¿‡æŒ‰`f5`åˆ·æ–°çš„è¯è¿˜æ˜¯ä¼šå‘èµ·è¯·æ±‚çš„ã€‚

å®ç°ä¿å­˜ç¼“å­˜åˆ°æœ¬åœ°å­˜å‚¨çš„åŠŸèƒ½ä¹Ÿå¾ˆç®€å•ï¼Œåªè¦ç»§æ‰¿`AxiosRequestTemplate` `Cache`ï¼Œå¹¶é‡å†™`Cache`çš„`getter` `setter`ä»¥åŠ`AxiosRequestTemplate`çš„`init`æ–¹æ³•å°±å¯ä»¥å®ç°ã€‚

### è‡ªå®šä¹‰ç¼“å­˜å‘½ä¸­ç­–ç•¥

> é»˜è®¤ç¼“å­˜å‘½ä¸­ç­–ç•¥ä¸º `{url,headers,data,method}`4 ä¸ªåˆæˆçš„å¯¹è±¡è½¬ä¸ºçš„å­—ç¬¦ä¸²æ˜¯ä¸€æ ·çš„åˆ™ä¼šå‘½ä¸­ç¼“å­˜ç°åœ¨åœ¨åŸæœ‰åŸºç¡€ä¸Šæ·»åŠ ä¸€æ¡ï¼šæ ¹æ®`tag`å‘½ä¸­ç¼“å­˜

è‡ªå®šä¹‰æ¨¡æ¿

```ts
export default class MyCacheTemplate extends AxiosRequestTemplate {
  private readonly cacheKeys = ['cache', 'login'];
  private constructor() {
    super({ baseURL: 'http://test.test' });
  }

  // è½¬æ¢ç¼“å­˜æ‰€ç”¨çš„keyï¼Œé»˜è®¤æ ¹æ®é…ç½®ç”Ÿæˆkey
  protected generateRequestKey(ctx) {
    // åªè¦æ˜¯tagåœ¨cacheKeysä¸­å°±å‘½ä¸­ç¼“å­˜
    const tag = ctx.customConfig.tag;
    if (cacheKeys.includes(tag)) {
      return tag;
    }
    // å¤ç”¨ä¹‹å‰çš„é€»è¾‘
    return super.generateRequestKey(ctx);
  }
}
```

### post è¯·æ±‚å‚æ•°åºåˆ—åŒ–

> æœ‰æ—¶å€™åç«¯è¦æ±‚`Content-Type`å¿…é¡»ä»¥`application/x-www-form-urlencoded`å½¢å¼ï¼Œè¿™æ—¶å€™æˆ‘ä»¬éœ€è¦å¤„ç†ä¸€ä¸‹`headers`å’Œ`data`Caz

è‡ªå®šä¹‰æ¨¡æ¿

```ts
import Qs from 'qs';
export default class MyTemplate extends AxiosRequestTemplate {
  protected handleRequestConfig(requestConfig) {
    requestConfig = super.handleRequestConfig(requestConfig);
    //  è®¾ç½®headers
    if (!requestConfig.headers) requestConfig.headers = {};
    requestConfig.headers['Content-Type'] = 'application/x-www-form-urlencoded';

    // qsåºåˆ—åŒ–
    if (
      String(requestConfig.method).toLowerCase() === 'post' &&
      !(requestConfig.data instanceof FormData)
    ) {
      requestConfig.data = Qs.stringify(requestConfig.data);
    }

    return requestConfig;
  }
}
```

æˆ–è€…ä½¿ç”¨`axios`å…¨å±€é…ç½®

```ts
import Qs from 'qs';
export default class MyTemplate extends AxiosRequestTemplate {
  constructor() {
    //  è®¾ç½®headers
    super({ headers: { 'Content-Type': 'application/x-www-form-urlencoded' } });
  }

  protected handleRequestConfig(requestConfig) {
    requestConfig = super.handleRequestConfig(requestConfig);
    // qsåºåˆ—åŒ–
    if (
      String(requestConfig.method).toLowerCase() === 'post' &&
      !(requestConfig.data instanceof FormData)
    ) {
      requestConfig.data = Qs.stringify(requestConfig.data);
    }
    return requestConfig;
  }
}
```

### åˆ†é¡µåœºæ™¯å¿«é€Ÿåˆ‡æ¢é¡µç æ—¶ä¸­æ–­è¯·æ±‚

> åˆ†é¡µåœºæ™¯ï¼Œå¿«é€Ÿçš„ç‚¹å‡» 1ï¼Œ2ï¼Œ3 é¡µï¼Œå‘å‡ºå» 3 ä¸ªè¯·æ±‚ï¼Œè¯·æ±‚è¿”å›æœ‰å¿«æœ‰æ…¢ï¼Œæœ€åç‚¹å‡»çš„ç¬¬ä¸‰é¡µï¼Œä½†æ˜¯æœ€åè¿”å›çš„æ˜¯ç¬¬äºŒé¡µçš„æ•°æ®ï¼Œé‚£é¡µé¢ï¼Œè‚¯å®šæ˜¯ä¼šæ¸²æŸ“ç¬¬äºŒé¡µçš„ï¼Œæ˜¯ä¸æ˜¯ä¸ª bugï¼Œé‚£ä¹ˆåŒæ—¶è¯·æ±‚äº†å¤šä¸ªç›¸åŒè¯·æ±‚ï¼Œé‚£ä¹ˆæ˜¯ä¸æ˜¯å¯ä»¥ä¸­æ–­ä¹‹å‰çš„è¯·æ±‚ï¼Œåªæ‰§è¡Œæœ€åä¸€ä¸ªè¯·æ±‚å‘¢

è¿™ç§åœºæ™¯æŒºå¸¸è§çš„ï¼Œè·Ÿä¸Šé¢çš„é¡µé¢é¢‘ç¹æ“ä½œç±»ä¼¼ï¼Œä¸è¿‡ä»ç¼“å­˜æ‹¿æ•°æ®å¾ˆå¿«ï¼Œç”¨æˆ·ç‚¹å‡»ä¸å¯èƒ½ä¼šæ¯”ä»ç¼“å­˜æ‹¿æ•°æ®å¿«ã€‚

æˆ‘ä»¬å¯ä»¥å¾ˆç®€å•çš„å®ç°è¯¥åŠŸèƒ½

```ts
const req = new AxiosRequestTemplate();
// ä½¿ç”¨Symbolé¿å…ä¸å…¶ä»–è¯·æ±‚é‡å
const tag = Symbol('xx_list');
// api
export function getXXList(p: number) {
  req.cancelWithTag(tag);
  return req.request({ url: '/xx_list', params: { p } }, { tag });
}
```

åªè¦ç»™è¯¥è¯·æ±‚åŠ ä¸Š`tag`ï¼Œç„¶åæ¯æ¬¡è°ƒç”¨å‰å–æ¶ˆå°±å¥½äº†ï¼Œæ˜¯ä¸æ˜¯å¾ˆç®€å•å‘¢ã€‚

## å®Œæ•´ demo

è¿™æ˜¯æˆ‘åšå®¢å‰å°çš„`api`ä½¿ç”¨å°è£…

ç¯å¢ƒï¼švue3ã€viteã€tsã€elementplus

ç›®å½•ç»“æ„

```text
src
â”œâ”€â”€ api
|  â”œâ”€â”€ user.ts // å…·ä½“çš„api
|  â”œâ”€â”€ tag.ts // å…·ä½“çš„api
|  â””â”€â”€ ....
â”œâ”€â”€ http
|  â”œâ”€â”€â”€ primary // ä¸»æ¨¡æ¿
|  |   â”œâ”€â”€ index.ts // è¯·æ±‚æ¨¡æ¿
|  |   â”œâ”€â”€ token.ts // tokenæ“ä½œå·¥å…·ç±»
|  |   â””â”€â”€ statusHandlers.ts // çŠ¶æ€å¤„ç†
|  â””â”€â”€â”€ other  // å…¶ä»–è§„åˆ™æ¨¡æ¿
|      â”œâ”€â”€ index.ts // è¯·æ±‚æ¨¡æ¿
|      â””â”€â”€ statusHandlers.ts // çŠ¶æ€å¤„ç†
```

### ä¸»æ¨¡æ¿å°è£…

#### src/primary/token.ts

`token`å°è£…ç±»

```ts
export class Token {
  private static KEY = 'token';

  static set key(key: string) {
    Token.KEY = key;
  }
  static get key(): string {
    return Token.KEY;
  }

  static get(): string {
    return localStorage.getItem(Token.KEY) || '';
  }
  static set(token: string) {
    localStorage.setItem(Token.KEY, token);
  }

  static clear() {
    localStorage.removeItem(Token.KEY);
  }
  static exists(): boolean {
    return !!Token.get();
  }
}
```

#### src/primary/statusHandlers.ts

ç»™ç”¨æˆ·æç¤ºé”™è¯¯ä¿¡æ¯ï¼Œ`token`çš„ä¿å­˜ã€æ¸…ç†ã€åˆ·æ–°ç­‰æ“ä½œçš„é€šç”¨å¤„ç†

```ts
import { HttpStatus, StatusHandler, StatusHandlers, CustomConfig } from 'request-template';
import { ElMessage } from 'element-plus';
import { Token } from './token';
import Store from '@/store/index';

// é€šç”¨é”™è¯¯Handler
const commonErrorHandler: StatusHandler<CustomConfig> = ({ customConfig }, res, data) => {
  // éé™éŸ³æ¨¡å¼ä¸‹ï¼Œæœ‰é”™è¯¯ç›´æ¥æ˜¾ç¤ºé”™è¯¯ä¿¡æ¯
  !customConfig.silent && ElMessage({ type: 'error', message: data.msg });
  return Promise.reject(customConfig.returnRes ? res : data);
};

export const statusHandlers: StatusHandlers = {
  //  401 tokenå¤±æ•ˆæˆ–è€…æœªç™»å½•
  [HttpStatus.UNAUTHORIZED]: (ctx, res, data) => {
    // ä»vuexæˆ–piniaä¸­åˆ é™¤ç”¨æˆ·ä¿¡æ¯
    // Store.commit('clearUser');
    Token.clear();
    return commonErrorHandler(ctx, res, data);
  },
  // tokenåˆ·æ–°æ—¶
  207: ({ customConfig }, res, data) => {
    data.data.token && Token.set(data.data.token);
    return customConfig.returnRes ? res : data;
  },
  // 200 æ™®é€šæˆåŠŸè¯·æ±‚
  [HttpStatus.OK]: ({ customConfig }, res, data) => {
    return customConfig.returnRes ? res : data;
  },
  // ...
  // å…¶ä½™çŠ¶æ€å…¨éƒ¨èµ°é”™è¯¯å¤„ç†
  default: commonErrorHandler,
};
```

#### src/primary/index.ts

å®ç°è‡ªå®šä¹‰è¯·æ±‚æ¨¡æ¿

```ts
import { Token } from './token';
import { statusHandlers } from './statusHandlers';
import { AxiosRequestTemplate, Context, CustomConfig } from 'request-template';
import { ElLoading, ILoadingInstance } from 'element-plus';
import { Method } from 'axios';

let uuid = localStorage.getItem('uuid');

interface LoadingCustomConfig extends CustomConfig {
  loading?: boolean;
}

export class PrimaryRequest<
  CC extends LoadingCustomConfig = LoadingCustomConfig,
> extends AxiosRequestTemplate<CC> {
  // å•ä¾‹æ¨¡å¼
  static readonly ins = new PrimaryRequest();

  private loading?: ILoadingInstance;

  private constructor() {
    super(
      //  baseUrlï¼Œaxiosé…ç½®ï¼Œæ¯ä¸ªè¯·æ±‚éƒ½ä¼šæ‹¼æ¥ä¸ŠbaseUrlä½œä¸ºå‰ç¼€ï¼Œè·Ÿprocess.env.BASE_URLç±»ä¼¼
      { baseURL: import.meta.env.VITE_BASE_URL },
      // ç¼“å­˜è®¾ç½®60ç§’
      { statusHandlers, cache: { enable: false, timeout: 60 * 1000 }, loading: false } as CC,
    );
  }

  // è¯·æ±‚å‰å¼€å¯loading
  protected beforeRequest(ctx: Context<CC>) {
    super.beforeRequest(ctx); // å¤ç”¨åŸºç¡€æ¨¡æ¿é€»è¾‘
    if (ctx.customConfig.loading) {
      this.loading = ElLoading.service({ fullscreen: true });
    }
  }

  // è¯·æ±‚åå…³é—­loading
  protected afterRequest(ctx) {
    super.afterRequest(ctx); // å¤ç”¨åŸºç¡€æ¨¡æ¿é€»è¾‘
    // åŠ ä¸ªå®šæ—¶å™¨é¿å…è¯·æ±‚å¤ªå¿«ï¼Œloadingä¸€é—ªè€Œè¿‡
    setTimeout(() => {
      this.loading?.close();
    }, 200);
  }

  // ç”Ÿæˆuuid
  private static getUUID() {
    if (uuid) {
      return uuid;
    }
    uuid = Math.floor(Math.random() * 0xffffffffff).toString(16);
    localStorage.setItem('uuid', uuid);
    return uuid;
  }

  // å¤„ç†configï¼Œæ·»åŠ uuidå’Œtokenåˆ°headers
  protected handleRequestConfig(requestConfig) {
    if (!requestConfig.headers) requestConfig.headers = {};
    Token.exists() && (requestConfig.headers.authorization = `Bearer ${Token.get()}`);
    requestConfig.headers.uuid = PrimaryRequest.getUUID();
    return super.handleRequestConfig(requestConfig);
  }

  // é€šè¿‡æ•°ç»„ç”Ÿæˆmethod
  methodsWithUrl(methods: Method[], urlPrefix: string) {
    return methods.map((method) => this.simplifyMethodFactory(method, urlPrefix));
  }
}

// å¯¼å‡ºå…¬å…±çš„method
export const [Get, Post, Patch, Delete] = PrimaryRequest.ins.methodsWithUrl(
  ['get', 'post', 'patch', 'delete'],
  '',
);
```

#### src/api/user.ts

user æ¨¡å—

```ts
import { PrimaryRequest } from '@/http/primary';

// å¤ç”¨urlå‰ç¼€
const urlPrefix = '/api/user';
const [Get, Post, Patch, Delete] = PrimaryRequest.ins.methodsWithUrl(
  ['get', 'post', 'patch', 'delete'],
  urlPrefix,
);

export interface User {
  id: number;
  nickname: string;
  avatar: string;
  username: string;
  loginAt: string;
  createAt: string;
  muted: boolean;
  deletedAt: string;
}
export function getSelf() {
  return Get<{ user: User }>('/self', {}, { silent: true });
}
export function deleteUser(id: string | number) {
  return Delete('/' + id);
}
export function restoreUser(id: string | number) {
  return Patch('/restore/' + id);
}
export function getUserAll() {
  return Get<{ list: User[]; count: number }>(urlPrefix, {});
}
export function getUserById(id: number | string) {
  return Get<User>('/' + id);
}
export function login(data: {}) {
  return Post<{ token: string }>('/login', data);
}
export function register(data: {}) {
  return Post('/register', data);
}
export function updateUserInfo(userId: number | string, data: {}) {
  return Patch('/' + userId, data);
}
export function updatePassword(userId: number | string, data: {}) {
  return Patch('/password/' + userId, data);
}
export function muteUser(userId: number | string) {
  return Patch('/mute/' + userId);
}
export function cancelMuteUser(userId: number | string) {
  return Patch('/cancel-mute/' + userId);
}
```

#### src/api/tag.ts

tag æ¨¡å—

```ts
import { Get, Post } from '@/http/primary';

const url = '/api/tag';

export interface Tag {
  createAt: string;
  description: string;
  id: number | string;
  name: string;
}

export function createTag(data: {}) {
  return Post(url, data);
}

export function getTags() {
  return Get<Tag[]>(url);
}
```
